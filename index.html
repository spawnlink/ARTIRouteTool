<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartRoute - Logistics & Weather Engine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Leaflet Map CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <!-- Leaflet Map JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <style>
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 2s linear infinite;
            display: inline-block;
            vertical-align: middle;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        table { table-layout: fixed; width: 100%; border-collapse: collapse; }
        th, td { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        
        #map {
            height: 600px;
            width: 100%;
            border-radius: 0.75rem;
            border: 1px solid #e2e8f0;
            z-index: 10;
        }

        .cat-badge {
            background-color: #f59e0b;
            color: white;
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 900;
            text-transform: uppercase;
            margin-left: 6px;
            display: inline-block;
            vertical-align: middle;
            box-shadow: 0 1px 2px rgba(0,0,0,0.15);
            border: 1px solid #d97706;
        }

        .wash-badge {
            background-color: #2563eb;
            color: white;
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 900;
            text-transform: uppercase;
            margin-left: 6px;
            display: inline-block;
            vertical-align: middle;
            box-shadow: 0 1px 2px rgba(0,0,0,0.15);
            border: 1px solid #1e3a8a;
        }

        .section-card {
            background: white;
            border-radius: 0.75rem;
            border: 1px solid #e2e8f0;
            margin-bottom: 1.5rem;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            font-size: 0.65rem;
            font-weight: 800;
            color: #475569;
            margin-top: 0.3rem;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .nearest-cat-row { background-color: #fffbeb !important; border-left: 10px solid #f59e0b !important; }
        .wash-row { background-color: #eff6ff !important; border-left: 10px solid #2563eb !important; }

        .weather-icon-marker {
            background: white;
            border: 2px solid #ef4444;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
            cursor: pointer;
        }

        .leaflet-tooltip-own {
            background: rgba(15, 23, 42, 0.9);
            color: white;
            border: none;
            border-radius: 4px;
            font-weight: 700;
            font-size: 0.75rem;
            padding: 2px 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        #debugLogContainer {
            transition: all 0.3s ease-in-out;
        }
        #debugLog {
            background: #0f172a;
            transition: height 0.3s ease-in-out;
        }
        .log-timestamp { color: #6366f1; font-weight: bold; margin-right: 6px; }
        .log-header { color: #f8fafc; font-weight: 900; background: #1e293b; padding: 4px; margin-top: 8px; border-bottom: 1px solid #334155; display: block; text-transform: uppercase; font-size: 0.7rem; }

        .measurer-box {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border: 1px solid #cbd5e1;
            min-width: 180px;
            pointer-events: none;
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen p-4 md:p-8 font-sans text-slate-900">

    <div class="max-w-full mx-auto bg-white rounded-xl shadow-lg overflow-hidden border border-slate-200">
        <div class="bg-blue-900 p-6 text-white">
            <h1 class="text-3xl font-bold flex items-center gap-2">
                üöÄ SmartRoute
            </h1>
            <p class="text-blue-100 text-base mt-1">
                US-Only Dispatch Engine: Road-Following ROI Calculation ($0.50/mi vs. Tolls), 1.6mi Toll Net, and Live Radar.
            </p>
        </div>

        <div class="p-6">
            <div id="dataLoadingStatus" class="mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg text-yellow-800 font-medium text-sm flex items-center gap-3">
                <div class="loader !w-4 !h-4 !border-2"></div>
                Syncing global logistics, toll, and brand-aware wash databases...
            </div>

            <!-- Route Inputs -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="p-3 bg-slate-50 rounded-lg border border-slate-200">
                    <label class="block text-xs font-black text-slate-500 uppercase tracking-widest mb-1">Pickup (Start)</label>
                    <input type="text" id="startInput" placeholder="City, State" class="w-full border p-2 rounded-md focus:ring-2 focus:ring-blue-500 outline-none text-sm font-bold">
                    <label class="checkbox-label"><input type="checkbox" id="startWash" tabindex="-1"> Add Wash</label>
                    <label class="checkbox-label"><input type="checkbox" id="startScale" tabindex="-1"> Add Scale Check</label>
                    <label class="checkbox-label text-blue-600"><input type="checkbox" id="startWeather" tabindex="-1"> Weather Check (Next Leg)</label>
                    <label class="checkbox-label text-purple-600"><input type="checkbox" id="startAvoidToll" tabindex="-1"> Smart Avoid Tolls (Next Leg)</label>
                </div>
                <div class="p-3 bg-slate-50 rounded-lg border border-slate-200">
                    <label class="block text-xs font-black text-slate-500 uppercase tracking-widest mb-1">Stop 1</label>
                    <input type="text" id="stop1Input" placeholder="City, State" class="w-full border p-2 rounded-md focus:ring-2 focus:ring-blue-500 outline-none text-sm font-bold">
                    <label class="checkbox-label"><input type="checkbox" id="stop1Wash" tabindex="-1"> Add Wash</label>
                    <label class="checkbox-label"><input type="checkbox" id="stop1Scale" tabindex="-1"> Add Scale Check</label>
                    <label class="checkbox-label text-blue-600"><input type="checkbox" id="stop1Weather" tabindex="-1"> Weather Check (Next Leg)</label>
                    <label class="checkbox-label text-purple-600"><input type="checkbox" id="stop1AvoidToll" tabindex="-1"> Smart Avoid Tolls (Next Leg)</label>
                </div>
                <div class="p-3 bg-slate-50 rounded-lg border border-slate-200">
                    <label class="block text-xs font-black text-slate-500 uppercase tracking-widest mb-1">Stop 2</label>
                    <input type="text" id="stop2Input" placeholder="City, State" class="w-full border p-2 rounded-md focus:ring-2 focus:ring-blue-500 outline-none text-sm font-bold">
                    <label class="checkbox-label"><input type="checkbox" id="stop2Wash" tabindex="-1"> Add Wash</label>
                    <label class="checkbox-label"><input type="checkbox" id="stop2Scale" tabindex="-1"> Add Scale Check</label>
                    <label class="checkbox-label text-blue-600"><input type="checkbox" id="stop2Weather" tabindex="-1"> Weather Check (Next Leg)</label>
                    <label class="checkbox-label text-purple-600"><input type="checkbox" id="stop2AvoidToll" tabindex="-1"> Smart Avoid Tolls (Next Leg)</label>
                </div>
                <div class="p-3 bg-slate-50 rounded-lg border border-slate-200">
                    <label class="block text-xs font-black text-slate-500 uppercase tracking-widest mb-1">Delivery (End)</label>
                    <input type="text" id="endInput" placeholder="City, State" class="w-full border p-2 rounded-md focus:ring-2 focus:ring-blue-500 outline-none text-sm font-bold">
                    <label class="checkbox-label"><input type="checkbox" id="endWash" tabindex="-1"> Add Wash</label>
                    <label class="checkbox-label"><input type="checkbox" id="endScale" tabindex="-1"> Add Scale Check</label>
                </div>
            </div>

            <button onclick="calculateAndCheck()" id="checkBtn" disabled class="w-full bg-blue-700 hover:bg-blue-800 disabled:bg-slate-300 disabled:cursor-not-allowed text-white font-bold py-5 px-6 rounded-xl shadow-lg transition flex items-center justify-center gap-2 text-2xl tracking-tight">
                <span id="btnText">Initializing Data...</span>
            </button>

            <!-- Collapsible Debug Window -->
            <div id="debugLogContainer" class="mt-4 border border-slate-700 rounded-lg overflow-hidden bg-[#0f172a] hidden">
                <div onclick="toggleLog()" class="cursor-pointer bg-[#1e293b] p-2 flex justify-between items-center text-slate-300 text-[10px] font-black uppercase tracking-widest border-b border-slate-700">
                    <div class="flex items-center gap-2">
                        <span id="logArrow">‚ñº</span>
                        <span>Operational Dispatch Logs</span>
                    </div>
                    <span class="opacity-50">Real-time sync telemetry</span>
                </div>
                <div id="debugLog" class="text-green-400 text-xs font-mono overflow-y-auto h-0">
                    <div id="logLines" class="p-3"></div>
                </div>
            </div>

            <div id="loading" class="hidden mt-6 p-6 bg-blue-50 text-blue-700 rounded-xl text-center border border-blue-100">
                <div class="loader mr-3"></div> 
                <span id="loadingText" class="font-bold text-xl text-blue-800">Processing Logistics Chain...</span>
            </div>

            <!-- Toll Summary Section -->
            <div id="tollSection" class="hidden mb-6 bg-purple-50 border border-purple-200 rounded-lg p-4 shadow-sm">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-lg font-bold text-purple-900 flex items-center gap-2">
                        <span class="text-xl">üí∞</span> Cumulative Toll Gantry Costs (5-Axle)
                    </h3>
                    <span id="totalTollCost" class="bg-purple-600 text-white px-4 py-1.5 rounded-full text-lg font-bold"></span>
                </div>
                <div id="tollList" class="text-xs text-purple-800 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-x-4 gap-y-1 max-h-48 overflow-y-auto mt-2">
                </div>
            </div>

            <div id="resultsArea" class="hidden">
                
                <!-- ORIGIN SCALE SECTION -->
                <div id="scaleSection" class="hidden section-card mb-6 border-amber-200 bg-amber-50">
                    <div class="bg-amber-600 text-white px-4 py-2 font-black uppercase text-xs tracking-widest flex items-center gap-2">
                        ‚≠ê Requested CAT Scale Checks (50mi Radius)
                    </div>
                    <div class="p-0">
                        <table class="w-full text-left">
                            <tbody id="scaleTableBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- TRUCK WASH SECTION -->
                <div id="washSection" class="hidden section-card mb-6 border-blue-200 bg-blue-50">
                    <div class="bg-blue-600 text-white px-4 py-2 font-black uppercase text-xs tracking-widest flex items-center gap-2">
                        üíß Nearby Truck Washes (50mi Radius of Checked Stops)
                    </div>
                    <div class="p-0">
                        <table class="w-full text-left">
                            <tbody id="washTableBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- MAIN TRIP REPORT (Weather) -->
                <div id="weatherSection" class="hidden section-card">
                    <div class="bg-slate-800 text-white px-4 py-2 font-black uppercase text-xs tracking-widest flex justify-between items-center">
                        <span class="flex items-center gap-2">üó∫Ô∏è Operational Trip Report (Weather Hazards)</span>
                        <span id="timestamp" class="text-[10px] italic opacity-70"></span>
                    </div>
                    <div class="p-0">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="bg-slate-100 border-b border-slate-200">
                                    <th class="p-2 text-xs font-black uppercase text-slate-500 w-28">State</th>
                                    <th class="p-2 text-xs font-black uppercase text-slate-500 w-48">Location</th>
                                    <th class="p-2 text-xs font-black uppercase text-slate-500 w-32 text-center">Events</th>
                                    <th class="p-2 text-xs font-black uppercase text-slate-500 w-64">Timings</th>
                                    <th class="p-2 text-xs font-black uppercase text-slate-500 w-24 text-center">Links</th>
                                </tr>
                            </thead>
                            <tbody id="alertTableBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- LEG DISPATCH DATA -->
                <div id="legDisplay" class="hidden mb-4 p-4 bg-slate-50 border border-slate-200 rounded-xl shadow-sm">
                    <h3 class="text-xs font-black uppercase text-slate-400 tracking-widest mb-3 flex items-center gap-2">
                        üèÅ Dispatch Legs & Road Distances
                    </h3>
                    <div id="legList" class="flex flex-wrap gap-4 items-center"></div>
                </div>

                <div id="mapSection" class="mt-4 relative">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-xl font-bold text-gray-800 border-b pb-2 flex-grow">Infrastructure Visualization</h3>
                        <button id="radarBtn" onclick="toggleRadar()" class="ml-4 bg-slate-200 hover:bg-slate-300 text-slate-700 px-4 py-1.5 rounded-lg text-xs font-black uppercase tracking-tighter shadow-sm transition flex items-center gap-2 shrink-0">
                            üì° Toggle Live Radar
                        </button>
                    </div>
                    <div id="map" class="shadow-inner"></div>
                    
                    <!-- Measurer Overlay -->
                    <div id="measurerOverlay" class="measurer-box hidden">
                        <h4 class="text-[10px] font-black uppercase text-slate-400 mb-1">Road Distance Tool</h4>
                        <div id="measurerResults" class="text-sm">
                            <div class="flex justify-between border-b pb-1 mb-1">
                                <span class="font-bold text-blue-900">Road Miles:</span>
                                <span id="measureDist" class="font-black text-blue-700">--</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="font-bold text-blue-900">Drive Time:</span>
                                <span id="measureTime" class="font-black text-slate-700">--</span>
                            </div>
                            <p class="text-[8px] mt-2 text-slate-400 italic text-center">Click map to set A and B</p>
                        </div>
                    </div>

                    <div class="flex justify-center gap-4 mt-3 text-xs flex-wrap">
                        <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-[#10b981]"></span> Pickup</div>
                        <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-[#ef4444]"></span> Delivery</div>
                        <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-[#2563eb]"></span> Intermediate Stop</div>
                        <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-[#3b82f6] shadow-[0_0_3px_#3b82f6]"></span> Weather Hub</div>
                        <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-[#facc15] shadow-[0_0_5px_#facc15]"></span> CAT Scale</div>
                        <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-blue-600 border border-white"></span> Truck Wash</div>
                        <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-[#a855f7]"></span> Toll Gantry</div>
                        <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-[#ff69b4]"></span> Triggered Toll</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let map = null, routeLayer = null, markerLayer = null, radarLayer = null;
        let hubs = [], tolls = [], washes = [];
        let sessionStartTime = 0;

        let measureMarkers = [];
        let measureLine = null;

        const FUEL_COST_PER_MILE = 0.50; // ROI Math Metric

        const stateAbbrMap = {
            'alabama': 'AL', 'alaska': 'AK', 'arizona': 'AZ', 'arkansas': 'AR', 'california': 'CA', 'colorado': 'CO', 'connecticut': 'CT', 'delaware': 'DE', 'florida': 'FL', 'georgia': 'GA', 'hawaii': 'HI', 'idaho': 'ID', 'illinois': 'IL', 'indiana': 'IN', 'iowa': 'IA', 'kansas': 'KS', 'kentucky': 'KY', 'louisiana': 'LA', 'maine': 'ME', 'maryland': 'MD', 'massachusetts': 'MA', 'michigan': 'MI', 'minnesota': 'MN', 'mississippi': 'MS', 'missouri': 'MO', 'montana': 'MT', 'nebraska': 'NE', 'nevada': 'NV', 'new hampshire': 'NH', 'new jersey': 'NJ', 'new mexico': 'NM', 'new york': 'NY', 'north carolina': 'NC', 'north dakota': 'ND', 'ohio': 'OH', 'oklahoma': 'OK', 'oregon': 'OR', 'pennsylvania': 'PA', 'rhode island': 'RI', 'south carolina': 'SC', 'south dakota': 'SD', 'tennessee': 'TN', 'texas': 'TX', 'utah': 'UT', 'vermont': 'VT', 'virginia': 'VA', 'washington': 'WA', 'west virginia': 'WV', 'wisconsin': 'WI', 'wyoming': 'WY'
        };

        const cityCsvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQCgGN8rGTUO3hN-b2QKMe3cLchE_45Y-xfsFciJc-YJ_NJ-Z3_TZSMzRV2Jthc-FYGpnQoycZmvVpv/pub?gid=0&single=true&output=csv";
        const tollCsvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQCgGN8rGTUO3hN-b2QKMe3cLchE_45Y-xfsFciJc-YJ_NJ-Z3_TZSMzRV2Jthc-FYGpnQoycZmvVpv/pub?gid=1793109645&single=true&output=csv";
        const washCsvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQCgGN8rGTUO3hN-b2QKMe3cLchE_45Y-xfsFciJc-YJ_NJ-Z3_TZSMzRV2Jthc-FYGpnQoycZmvVpv/pub?gid=819928679&single=true&output=csv";

        window.onload = async () => {
            await loadAllData();
            ['startInput', 'stop1Input', 'stop2Input', 'endInput'].forEach(id => {
                document.getElementById(id).addEventListener("keypress", (e) => {
                    if (e.key === "Enter") {
                        e.preventDefault();
                        if (!document.getElementById('checkBtn').disabled) calculateAndCheck();
                    }
                });
            });
        };

        function parseCSVLine(line) {
            const result = []; let cell = '', inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') inQuotes = !inQuotes;
                else if (char === ',' && !inQuotes) { result.push(cell); cell = ''; }
                else cell += char;
            }
            result.push(cell); return result;
        }

        function normalizeState(state) {
            if (!state) return "";
            state = state.trim().toLowerCase();
            if (stateAbbrMap[state]) return stateAbbrMap[state];
            return state.toUpperCase();
        }

        async function loadAllData() {
            const statusEl = document.getElementById('dataLoadingStatus'), checkBtn = document.getElementById('checkBtn');
            try {
                const cityRes = await fetch(cityCsvUrl);
                const cityText = await cityRes.text();
                const cityLines = cityText.split(/\r?\n/).filter(l => l.trim().length > 0);
                hubs = cityLines.slice(1).map(line => {
                    const parts = parseCSVLine(line);
                    if (parts.length < 4) return null;
                    return { name: parts[0].trim(), state: normalizeState(parts[1]), lat: parseFloat(parts[2]), lon: parseFloat(parts[3]), pop: parseInt(parts[4]) || 0, isCatScale: parts[5] ? (parts[5].toLowerCase().includes('true') || parts[5].trim() === '1') : false };
                }).filter(h => h !== null && !isNaN(h.lat));

                const tollRes = await fetch(tollCsvUrl);
                const tollText = await tollRes.text();
                if (tollText) {
                    const tollLines = tollText.split(/\r?\n/).filter(l => l.trim().length > 0);
                    const headers = parseCSVLine(tollLines[0]).map(h => h.trim().toLowerCase());
                    const latIdx = headers.findIndex(h => h.includes('lat')), lonIdx = headers.findIndex(h => h.includes('lon') || h.includes('lng') || h.includes('long')), nameIdx = headers.indexOf('name') !== -1 ? headers.indexOf('name') : (headers.indexOf('city') !== -1 ? headers.indexOf('city') : 0), rateIdx = headers.findIndex(h => h.includes('rate') || h.includes('price') || h.includes('cost') || h.includes('axle'));
                    tolls = tollLines.slice(1).map(line => {
                        const parts = parseCSVLine(line);
                        const lat = parseFloat(parts[latIdx]), lon = parseFloat(parts[lonIdx]);
                        if (isNaN(lat) || isNaN(lon)) return null;
                        const price = parseFloat((parts[rateIdx] || "0").replace(/[^0-9.]/g, '')) || 0;
                        return { name: parts[nameIdx]?.trim() || "Toll", lat, lon, price };
                    }).filter(t => t !== null);
                }

                const washRes = await fetch(washCsvUrl);
                const washText = await washRes.text();
                if (washText) {
                    const washLines = washText.split(/\r?\n/).filter(l => l.trim().length > 0);
                    const headers = parseCSVLine(washLines[0]).map(h => h.trim().toLowerCase());
                    const wLatIdx = headers.findIndex(h => h.includes('lat')), wLonIdx = headers.findIndex(h => h.includes('lon') || h.includes('lng') || h.includes('long')), wCityIdx = headers.findIndex(h => h === 'city'), wBrandIdx = headers.findIndex(h => h.includes('brand') || h.includes('brabd'));
                    washes = washLines.slice(1).map(line => {
                        const parts = parseCSVLine(line);
                        const lat = parseFloat(parts[wLatIdx]), lon = parseFloat(parts[wLonIdx]);
                        if (isNaN(lat) || isNaN(lon)) return null;
                        return { name: parts[wCityIdx]?.trim() || "Wash Location", brand: parts[wBrandIdx]?.trim() || "Independent", lat, lon };
                    }).filter(w => w !== null);
                }

                statusEl.innerHTML = `‚úÖ ${hubs.length.toLocaleString()} locations, ${tolls.length} tolls & ${washes.length} washes synced. Ready.`;
                statusEl.className = "mb-6 p-4 bg-green-50 border border-green-200 rounded-lg text-green-800 font-medium text-sm flex items-center gap-3";
                checkBtn.disabled = false; document.getElementById('btnText').innerText = "Analyze SmartRoute";
                initMap(); drawGlobalTolls();
            } catch (err) { log(`Sync Error: ${err.message}`, true); }
        }

        async function toggleRadar() {
            const btn = document.getElementById('radarBtn');
            if (radarLayer) {
                map.removeLayer(radarLayer);
                radarLayer = null;
                btn.className = "ml-4 bg-slate-200 hover:bg-slate-300 text-slate-700 px-4 py-1.5 rounded-lg text-xs font-black uppercase tracking-tighter shadow-sm transition flex items-center gap-2 shrink-0";
            } else {
                log("Fetching latest radar timestamps...");
                try {
                    const res = await fetch('https://api.rainviewer.com/public/weather-maps.json');
                    const data = await res.json();
                    const timestamp = data.radar.past[data.radar.past.length - 1].time;
                    radarLayer = L.tileLayer(`https://tilecache.rainviewer.com/v2/radar/${timestamp}/256/{z}/{x}/{y}/2/1_1.png`, { opacity: 0.9, zIndex: 100 }).addTo(map);
                    btn.className = "ml-4 bg-blue-600 hover:bg-blue-700 text-white px-4 py-1.5 rounded-lg text-xs font-black uppercase tracking-tighter shadow-sm transition flex items-center gap-2 shrink-0";
                } catch (e) { log("Radar Error: " + e.message, true); }
            }
        }

        function toggleLog(forceOpen = false) {
            const container = document.getElementById('debugLogContainer');
            const logBox = document.getElementById('debugLog');
            const arrow = document.getElementById('logArrow');
            const isOpen = logBox.style.height === '300px';
            if (forceOpen || !isOpen) { logBox.style.height = '300px'; arrow.innerText = '‚ñ≤'; container.classList.remove('hidden'); }
            else { logBox.style.height = '0px'; arrow.innerText = '‚ñº'; }
        }

        function logHeader(title) {
            const lines = document.getElementById('logLines');
            const entry = document.createElement('div');
            entry.className = 'log-header'; entry.innerText = title; lines.appendChild(entry);
        }

        function log(msg, isError = false) {
            const logBox = document.getElementById('debugLog'), lines = document.getElementById('logLines');
            const elapsed = Date.now() - sessionStartTime;
            const entry = document.createElement('div'); entry.style.color = isError ? '#ff6b6b' : '#4ade80';
            const timeSpan = document.createElement('span'); timeSpan.className = 'log-timestamp'; timeSpan.innerText = `[+${elapsed}ms]`;
            entry.appendChild(timeSpan); entry.appendChild(document.createTextNode(`> ${msg}`)); lines.appendChild(entry); logBox.scrollTop = logBox.scrollHeight;
        }

        async function geocode(location) {
            if (!location || !location.trim()) return null;
            const queryRaw = location.toLowerCase().trim();
            const parts = queryRaw.split(',').map(s => s.trim());
            const cityQuery = parts[0];
            let stateQuery = normalizeState(parts[1] || '');

            log(`Checking local database: ${location}...`);
            let match = hubs.find(h => h.name.toLowerCase() === cityQuery && (stateQuery === '' || h.state.toLowerCase() === stateQuery.toLowerCase()));
            if (match) return match;
            match = hubs.find(h => h.name.toLowerCase() === cityQuery);
            if (match) return match;
            match = hubs.find(h => queryRaw.includes(h.name.toLowerCase()) && (stateQuery === '' || queryRaw.includes(h.state.toLowerCase())));
            if (match) return match;

            log(`Polling Global API: ${location}...`);
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(location)}&countrycodes=us&limit=1&addressdetails=1`);
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.length > 0) {
                        const addr = data[0].address;
                        const stCode = normalizeState(addr.state || '');
                        return { name: location.split(',')[0].trim(), state: stCode, lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon) };
                    }
                }
            } catch (err) { log(`API Error: ${err.message}`, true); }
            return null;
        }

        function initMap() {
            if (!map) {
                map = L.map('map').setView([39.8283, -98.5795], 4);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(map);
                routeLayer = L.layerGroup().addTo(map); markerLayer = L.layerGroup().addTo(map);
                map.on('click', (e) => handleMapMeasure(e.latlng));
            }
        }

        async function handleMapMeasure(latlng) {
            const overlay = document.getElementById('measurerOverlay');
            overlay.classList.remove('hidden');
            if (measureMarkers.length >= 2) {
                measureMarkers.forEach(m => map.removeLayer(m));
                if (measureLine) map.removeLayer(measureLine);
                measureMarkers = []; measureLine = null;
                document.getElementById('measureDist').innerText = "--";
                document.getElementById('measureTime').innerText = "--";
            }
            const label = measureMarkers.length === 0 ? "A" : "B";
            const marker = L.circleMarker(latlng, { radius: 8, fillColor: '#6366f1', color: '#fff', weight: 2, fillOpacity: 1 }).addTo(map).bindTooltip(label, { permanent: true, direction: 'center', className: 'bg-transparent text-white border-none shadow-none font-black text-[8px]' });
            measureMarkers.push(marker);

            if (measureMarkers.length === 2) {
                document.getElementById('measureDist').innerText = "Routing...";
                const posA = measureMarkers[0].getLatLng(), posB = measureMarkers[1].getLatLng();
                try {
                    const url = `https://router.project-osrm.org/route/v1/driving/${posA.lng},${posA.lat};${posB.lng},${posB.lat}?overview=full&geometries=geojson`;
                    const res = await fetch(url);
                    const data = await res.json();
                    if (data.routes && data.routes.length > 0) {
                        const route = data.routes[0];
                        const distMiles = route.distance * 0.000621371; 
                        const driveHours = distMiles / 62.5;
                        measureLine = L.geoJSON(route.geometry, { style: { color: '#6366f1', weight: 4, opacity: 0.7, dashArray: '5, 10' } }).addTo(map);
                        document.getElementById('measureDist').innerText = `${distMiles.toFixed(1)} mi`;
                        document.getElementById('measureTime').innerText = `${driveHours.toFixed(2)} hrs`;
                    }
                } catch (e) {
                    measureLine = L.polyline([posA, posB], { color: '#ef4444', weight: 3, dashArray: '5, 10', opacity: 0.7 }).addTo(map);
                }
            }
        }

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 3963; 
            const dLat = (lat2 - lat1) * Math.PI / 180, dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }

        function interpolatePath(coords, intervalMiles) {
            if (!coords || coords.length === 0) return [];
            const densePath = [coords[0]];
            for (let i = 0; i < coords.length - 1; i++) {
                const p1 = coords[i], p2 = coords[i+1], d = getDistance(p1[1], p1[0], p2[1], p2[0]);
                if (d > intervalMiles) {
                    const steps = Math.floor(d / intervalMiles);
                    for (let j = 1; j <= steps; j++) {
                        const f = (j * intervalMiles) / d;
                        densePath.push([p1[0] + f * (p2[0] - p1[0]), p1[1] + f * (p2[1] - p1[1])]);
                    }
                }
                densePath.push(p2);
            }
            return densePath;
        }

        function drawGlobalTolls(activeUids = new Set()) {
            if (!markerLayer) return;
            tolls.forEach(t => {
                const uid = `${t.lat.toFixed(4)}-${t.lon.toFixed(4)}`;
                const isActive = activeUids.has(uid);
                L.circleMarker([t.lat, t.lon], { 
                    radius: isActive ? 6 : 4, 
                    fillColor: isActive ? '#ff69b4' : '#a855f7', 
                    color: "#fff", 
                    weight: isActive ? 2 : 1, 
                    opacity: isActive ? 1 : 0.6, 
                    fillOpacity: isActive ? 1 : 0.6 
                }).addTo(markerLayer).bindTooltip(`${t.name} ($${t.price.toFixed(2)})`); 
            });
        }

        async function fetchRouteOptions(start, end) {
            const url = `https://router.project-osrm.org/route/v1/driving/${start.lon},${start.lat};${end.lon},${end.lat}?overview=full&geometries=geojson&alternatives=3`;
            const res = await fetch(url);
            const data = await res.json();
            const avoidUrl = `https://router.project-osrm.org/route/v1/driving/${start.lon},${start.lat};${end.lon},${end.lat}?overview=full&geometries=geojson&exclude=toll`;
            let avoidData = null;
            try { const aRes = await fetch(avoidUrl); avoidData = await aRes.json(); } catch(e) {}
            return { routes: data.routes || [], avoidRoute: (avoidData && avoidData.routes) ? avoidData.routes[0] : null };
        }

        function getTollsOnPath(pathCoords) {
            if (!pathCoords || pathCoords.length < 2) return [];
            const dense = interpolatePath(pathCoords, 0.5); 
            const detected = [], seen = new Set();
            tolls.forEach(t => {
                let found = false;
                for (const p of dense) { if (getDistance(t.lat, t.lon, p[1], p[0]) < 1.6) { found = true; break; } } 
                const uid = `${t.lat.toFixed(4)}-${t.lon.toFixed(4)}`;
                if (found && !seen.has(uid)) { seen.add(uid); detected.push(t); }
            });
            return detected;
        }

        async function calculateAndCheck() {
            sessionStartTime = Date.now();
            toggleLog(true);

            const inputs = [
                { id: 'startInput', washId: 'startWash', scaleId: 'startScale', weatherId: 'startWeather', avoidTollId: 'startAvoidToll', tag: 'PICKUP' }, 
                { id: 'stop1Input', washId: 'stop1Wash', scaleId: 'stop1Scale', weatherId: 'stop1Weather', avoidTollId: 'stop1AvoidToll', tag: 'STOP 1' }, 
                { id: 'stop2Input', washId: 'stop2Wash', scaleId: 'stop2Scale', weatherId: 'stop2Weather', avoidTollId: 'stop2AvoidToll', tag: 'STOP 2' }, 
                { id: 'endInput', washId: 'endWash', scaleId: 'endScale', tag: 'DELIVERY' }
            ];

            const loading = document.getElementById('loading'), resArea = document.getElementById('resultsArea'), tollSection = document.getElementById('tollSection'), tollList = document.getElementById('tollList'), totalTollEl = document.getElementById('totalTollCost'), scaleSection = document.getElementById('scaleSection'), washSection = document.getElementById('washSection'), weatherSection = document.getElementById('weatherSection');
            
            loading.classList.remove('hidden'); resArea.classList.add('hidden'); tollSection.classList.add('hidden'); scaleSection.classList.add('hidden'); washSection.classList.add('hidden'); weatherSection.classList.add('hidden');
            document.getElementById('scaleTableBody').innerHTML = ''; document.getElementById('washTableBody').innerHTML = ''; document.getElementById('alertTableBody').innerHTML = ''; document.getElementById('legList').innerHTML = ''; document.getElementById('logLines').innerHTML = '';

            try {
                const filledPoints = [];
                for (let i = 0; i < inputs.length; i++) {
                    logHeader(`Processing ${inputs[i].tag}`);
                    const val = document.getElementById(inputs[i].id).value.trim();
                    if (val) {
                        const pt = await geocode(val);
                        if (pt) { 
                            pt.requestWash = document.getElementById(inputs[i].washId).checked; 
                            pt.requestScale = document.getElementById(inputs[i].scaleId).checked;
                            pt.requestWeather = inputs[i].weatherId ? document.getElementById(inputs[i].weatherId).checked : false;
                            pt.requestAvoid = inputs[i].avoidTollId ? document.getElementById(inputs[i].avoidTollId).checked : false;
                            filledPoints.push(pt); 
                            log(`Success: Found ${pt.name}, ${pt.state}`);
                        } else log(`Error: Location not found: "${val}"`, true);
                    }
                }
                if (filledPoints.length < 2) throw new Error("At least Pickup and one Destination required.");

                const waypoints = filledPoints.map((pt, idx, arr) => {
                    if (idx === 0) pt.label = "Pickup";
                    else if (idx === arr.length - 1) pt.label = "Delivery";
                    else pt.label = `Stop ${idx}`;
                    return pt;
                });

                logHeader("Analyzing Route Geometry & Corridor ROI");
                let roadCoords = [];
                let legDistances = [];
                let activeTolls = [];

                for (let i = 0; i < waypoints.length - 1; i++) {
                    const start = waypoints[i], end = waypoints[i+1];
                    const options = await fetchRouteOptions(start, end);
                    if (options.routes.length === 0) throw new Error(`Routing failed to ${end.name}`);

                    const stdRoute = options.routes[0];
                    const stdMiles = stdRoute.distance * 0.000621371;
                    const stdTolls = getTollsOnPath(stdRoute.geometry.coordinates);
                    const stdTollPrice = stdTolls.reduce((s,t) => s + t.price, 0);
                    
                    let chosenCoords = stdRoute.geometry.coordinates;
                    let chosenMiles = stdMiles;
                    let chosenTolls = stdTolls;

                    if (start.requestAvoid) {
                        logHeader(`ROI Analysis: ${start.name} ‚Üí ${end.name}`);
                        const candidates = [...options.routes];
                        if (options.avoidRoute) candidates.push(options.avoidRoute);

                        let bestPathTotalCost = (stdMiles * FUEL_COST_PER_MILE) + stdTollPrice;
                        let winningTag = "Standard";

                        candidates.forEach((route, ridx) => {
                            const miles = route.distance * 0.000621371;
                            const pathTolls = getTollsOnPath(route.geometry.coordinates);
                            const tollPrice = pathTolls.reduce((s,t) => s + t.price, 0);
                            const totalCost = (miles * FUEL_COST_PER_MILE) + tollPrice;
                            if (totalCost < bestPathTotalCost - 1) { 
                                bestPathTotalCost = totalCost; chosenCoords = route.geometry.coordinates; chosenMiles = miles; chosenTolls = pathTolls;
                                winningTag = (ridx === candidates.length - 1 && options.avoidRoute) ? "Strict Avoid" : `Alt #${ridx}`;
                            }
                        });
                        log(`‚úÖ Logic Choice: ${winningTag}. Saved: $${((stdMiles * FUEL_COST_PER_MILE + stdTollPrice) - bestPathTotalCost).toFixed(2)}`);
                    }

                    legDistances.push(chosenMiles);
                    activeTolls = activeTolls.concat(chosenTolls);
                    if (i > 0) chosenCoords.shift();
                    roadCoords = roadCoords.concat(chosenCoords);
                }

                const legDisplay = document.getElementById('legDisplay');
                const legList = document.getElementById('legList');
                legDisplay.classList.remove('hidden');
                legDistances.forEach((miles, i) => {
                    const div = document.createElement('div');
                    div.className = "bg-white p-2 rounded-lg border border-slate-300 shadow-sm flex items-center gap-2";
                    div.innerHTML = `<span class="text-[10px] font-black text-slate-400">#${i+1}</span> <span class="font-bold text-blue-900">${waypoints[i].name}</span> <span class="text-slate-400">‚Üí</span> <span class="font-bold text-blue-900">${waypoints[i+1].name}</span> <span class="bg-blue-600 text-white px-2 py-0.5 rounded text-xs font-black ml-2">${miles.toFixed(1)} mi</span>`;
                    legList.appendChild(div);
                });

                // Canada Guard
                let canadaDetected = false;
                for (const coord of roadCoords) { if (coord[1] > 42.35 && coord[0] > -82.8 && coord[0] < -79.0) { canadaDetected = true; break; } }
                if (canadaDetected) {
                    log(`‚ö†Ô∏è Canada Detected. Force-rerouting...`);
                    const cleveland = { name: "Cleveland", state: "OH", lat: 41.4993, lon: -81.6944 };
                    waypoints.splice(Math.ceil(waypoints.length / 2), 0, cleveland);
                }

                const uniqueTolls = []; const seenUids = new Set();
                activeTolls.forEach(t => { const uid = `${t.lat.toFixed(4)}-${t.lon.toFixed(4)}`; if (!seenUids.has(uid)) { seenUids.add(uid); uniqueTolls.push(t); } });
                if (uniqueTolls.length > 0) {
                    let total = 0; tollList.innerHTML = '';
                    uniqueTolls.forEach(t => { total += t.price; const div = document.createElement('div'); div.className = 'flex justify-between border-b border-purple-100 py-1 px-1'; div.innerHTML = `<span class="truncate pr-2 font-medium">${t.name}</span> <span class="font-bold shrink-0">$${t.price.toFixed(2)}</span>`; tollList.appendChild(div); });
                    totalTollEl.innerText = `Total: $${total.toFixed(2)}`; tollSection.classList.remove('hidden');
                }

                const scaleResults = [];
                waypoints.forEach(wp => {
                    if (wp.requestScale) {
                        const local = hubs.filter(h => h.isCatScale).map(h => ({...h, near: wp.name, dist: getDistance(wp.lat, wp.lon, h.lat, h.lon)})).filter(h => h.dist <= 50).sort((a,b) => a.dist - b.dist).slice(0, 3);
                        local.forEach(s => scaleResults.push(s));
                    }
                });
                const requestedWashes = [];
                waypoints.forEach(wp => {
                    if (wp.requestWash) {
                        washes.filter(w => getDistance(wp.lat, wp.lon, w.lat, w.lon) <= 50).map(w => ({...w, nearStop: wp.name, dist: getDistance(wp.lat, wp.lon, w.lat, w.lon)})).sort((a,b) => a.dist - b.dist).slice(0, 3).forEach(lw => requestedWashes.push(lw));
                    }
                });

                logHeader("Weather Polling");
                const tripSequence = [];
                let totalAlerts = 0;
                for (let i = 0; i < filledPoints.length; i++) {
                    const wp = filledPoints[i];
                    if (wp.requestWeather) {
                        const nextWp = filledPoints[i+1];
                        if (nextWp) {
                            let startIndex = 0, endIndex = 0, minSD = Infinity, minED = Infinity;
                            for (let j=0; j<roadCoords.length; j++) {
                                let dS = getDistance(wp.lat, wp.lon, roadCoords[j][1], roadCoords[j][0]);
                                if (dS < minSD) { minSD = dS; startIndex = j; }
                                let dE = getDistance(nextWp.lat, nextWp.lon, roadCoords[j][1], roadCoords[j][0]);
                                if (dE < minED) { minED = dE; endIndex = j; }
                            }
                            const legCoords = roadCoords.slice(startIndex, endIndex + 1);
                            const denseLeg = interpolatePath(legCoords, 0.5);
                            let currentTotalDist = 0, lastHubDist = 0;
                            tripSequence.push(wp);
                            for (let j = 1; j < denseLeg.length; j++) {
                                currentTotalDist += getDistance(denseLeg[j-1][1], denseLeg[j-1][0], denseLeg[j][1], denseLeg[j][0]);
                                if (currentTotalDist - lastHubDist >= 200) {
                                    const rp = denseLeg[j]; let closest = null, minDist = Infinity;
                                    hubs.forEach(h => { const d = getDistance(h.lat, h.lon, rp[1], rp[0]); if (d < 35 && d < minDist) { minDist = d; closest = h; } });
                                    if (closest && !tripSequence.some(s => s.name === closest.name)) { tripSequence.push(closest); lastHubDist = currentTotalDist; }
                                }
                            }
                            if (!tripSequence.some(s => s.name === nextWp.name)) tripSequence.push(nextWp);
                        }
                    }
                }

                tripSequence.sort((a,b) => getDistance(waypoints[0].lat, waypoints[0].lon, a.lat, a.lon) - getDistance(waypoints[0].lat, waypoints[0].lon, b.lat, b.lon));
                const uniqueTripSequence = Array.from(new Set(tripSequence.map(s => s.name + s.state))).map(id => tripSequence.find(s => (s.name + s.state) === id));

                for (const p of uniqueTripSequence) {
                    const alerts = await fetchWeather(p);
                    if (alerts.length > 0) { totalAlerts += alerts.length; appendWeatherGroup(p, alerts, document.getElementById('alertTableBody')); }
                }
                if (totalAlerts > 0) { weatherSection.classList.remove('hidden'); document.getElementById('timestamp').innerText = `${new Date().toLocaleTimeString()}`; }

                logHeader("Finalizing Map View");
                initMap(); 
                drawRoadMap({type: 'Feature', geometry: {type: 'LineString', coordinates: roadCoords}}, waypoints, scaleResults, requestedWashes, uniqueTripSequence, uniqueTolls);
                resArea.classList.remove('hidden'); setTimeout(() => map.invalidateSize(), 200);
                log("SmartRoute Analysis Complete.");

            } catch (err) { log(`System Error: ${err.message}`, true); } finally { loading.classList.add('hidden'); }
        }

        function appendOperationalRow(point, tbody, type) {
            const row = document.createElement('tr');
            let badge = type === 'scale' ? `<span class="cat-badge">‚≠ê SCALE NEAR ${point.near}</span>` : `<span class="wash-badge">${point.brand || 'WASH'} NEAR ${point.nearStop || 'STOP'}</span>`;
            const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${point.lat},${point.lon}`;
            let actionHtml = type === 'wash' ? `<a href="${mapsUrl}" target="_blank" tabindex="-1" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-[10px] font-black uppercase tracking-wider shadow-sm transition inline-block">Google Maps</a>` : '';
            row.className = `border-b border-slate-100 ${type === 'scale' ? 'nearest-cat-row' : 'wash-row'}`;
            row.innerHTML = `<td class="p-2 font-black text-blue-900 text-lg uppercase">${point.state || 'US'}</td><td class="p-2 font-bold text-slate-800 text-lg">${point.name}${badge}</td><td class="p-2 align-middle text-right pr-4">${actionHtml}</td>`;
            tbody.appendChild(row);
        }

        async function fetchWeather(point) {
            log(`NWS Polling: ${point.name}...`);
            try {
                const response = await fetch(`https://api.weather.gov/alerts/active?point=${parseFloat(point.lat).toFixed(4)},${parseFloat(point.lon).toFixed(4)}`);
                if (response.ok) {
                    const data = await response.json();
                    const filtered = (data.features || []).filter(f => {
                        const e = f.properties.event.toLowerCase();
                        return e.includes('winter') || e.includes('ice') || e.includes('snow') || e.includes('cold') || e.includes('wind') || e.includes('storm') || e.includes('flood') || e.includes('warning') || e.includes('watch') || e.includes('advisory') || e.includes('fog');
                    });
                    if (filtered.length > 0) {
                        point.weatherIcon = getWeatherEmoji(filtered[0].properties.event);
                        point.weatherLink = `https://forecast.weather.gov/MapClick.php?lat=${point.lat}&lon=${point.lon}`;
                        return filtered;
                    }
                }
            } catch (e) { log(`Weather Failure: ${point.name}`, true); }
            return [];
        }

        function appendWeatherGroup(point, alerts, tbody) {
            const row = document.createElement('tr');
            row.className = `border-b border-slate-100 hover:bg-slate-50`;
            let alertsHtml = '', timingHtml = '', linksHtml = '';
            alerts.forEach((alert, i) => {
                const border = i > 0 ? 'border-t border-slate-100 pt-2 mt-2' : '';
                alertsHtml += `<div class="${border} text-center"><span class="px-2 py-0.5 rounded text-[10px] font-black uppercase block ${getBadgeColor(alert.properties.event)}">${alert.properties.event}</span></div>`;
                timingHtml += `<div class="${border} text-[10px] font-bold leading-none"><div class="uppercase text-slate-400 mb-1">Starts: ${formatDate(alert.properties.effective)}</div><div class="uppercase text-slate-400">Ends: ${formatDate(alert.properties.ends || alert.properties.expires)}</div></div>`;
                linksHtml += `<div class="${border} text-center"><a href="https://forecast.weather.gov/MapClick.php?lat=${point.lat}&lon=${point.lon}" target="_blank" class="bg-slate-700 text-white px-2 py-1 rounded text-[10px] uppercase font-black shrink-0">View</a></div>`;
            });
            row.innerHTML = `<td class="p-2 font-black text-blue-900 text-lg uppercase align-top">${point.state || 'US'}</td><td class="p-2 font-bold text-slate-800 text-lg align-top">${point.name}</td><td class="p-2 align-top">${alertsHtml}</td><td class="p-2 align-top">${timingHtml}</td><td class="p-2 align-top">${linksHtml}</td>`;
            tbody.appendChild(row);
        }

        function getWeatherEmoji(event) {
            const e = event.toLowerCase();
            if (e.includes('snow') || e.includes('winter')) return '‚ùÑÔ∏è';
            if (e.includes('ice') || e.includes('freeze')) return 'üßä';
            if (e.includes('wind')) return 'üí®';
            if (e.includes('storm') || e.includes('thunder')) return '‚õàÔ∏è';
            if (e.includes('flood')) return 'üåä';
            if (e.includes('fog')) return 'üå´Ô∏è';
            return '‚ö†Ô∏è';
        }

        function drawRoadMap(geo, waypoints, originScales, requestedWashes, tripSequence, activeTolls = []) {
            routeLayer.clearLayers(); markerLayer.clearLayers();
            L.geoJSON(geo, { style: { color: '#2563eb', weight: 6, opacity: 0.8 } }).addTo(routeLayer);
            const activeUids = new Set(activeTolls.map(t => `${t.lat.toFixed(4)}-${t.lon.toFixed(4)}`));
            drawGlobalTolls(activeUids); 
            tripSequence.forEach(p => {
                const isWP = waypoints.find(wp => wp.lat === p.lat && wp.lon === p.lon);
                const color = isWP ? (isWP.label === 'Pickup' ? '#10b981' : (isWP.label === 'Delivery' ? '#ef4444' : '#2563eb')) : '#3b82f6';
                const markerLabel = isWP ? `${isWP.label}: ${isWP.name}, ${isWP.state}` : `${p.name}, ${p.state}`;
                const size = isWP ? 10 : 4;
                if (p.weatherIcon) {
                    const icon = L.divIcon({ className: 'weather-icon-marker', html: p.weatherIcon, iconSize: [30, 30] });
                    const m = L.marker([p.lat, p.lon], { icon }).addTo(markerLayer).bindTooltip(markerLabel, { permanent: true, direction: 'top', className: 'leaflet-tooltip-own' });
                    m.on('click', () => window.open(p.weatherLink, '_blank'));
                } else {
                    L.circleMarker([p.lat, p.lon], { radius: size, fillColor: color, color: "#fff", weight: 1.5, opacity: 1, fillOpacity: 1 }).addTo(markerLayer).bindTooltip(markerLabel, { permanent: true, direction: 'top', className: 'leaflet-tooltip-own' });
                }
            });
            originScales.forEach(s => L.circleMarker([s.lat, s.lon], { radius: 8, fillColor: '#facc15', color: "#fff", weight: 2.5, opacity: 1, fillOpacity: 1 }).addTo(markerLayer).bindTooltip(`SCALE: ${s.name}`, { direction: 'bottom' }));
            requestedWashes.forEach(w => L.circleMarker([w.lat, w.lon], { radius: 7, fillColor: '#2563eb', color: "#fff", weight: 2, opacity: 1, fillOpacity: 1 }).addTo(markerLayer).bindTooltip(`WASH: ${w.brand} ${w.name}`, { direction: 'bottom' }));
            map.fitBounds(L.latLngBounds(geo.geometry.coordinates.map(c => [c[1], c[0]])), { padding: [150, 150], maxZoom: 5 });
        }

        function getBadgeColor(event) {
            const e = event.toLowerCase();
            if (e.includes('warning')) return 'bg-red-600 text-white';
            if (e.includes('watch')) return 'bg-orange-500 text-white';
            return 'bg-blue-600 text-white';
        }

        function formatDate(str) {
            if (!str) return "--";
            const d = new Date(str), h = d.getHours();
            let p = h >= 5 && h < 12 ? "AM" : (h >= 12 && h < 17) ? "PM" : "Night";
            return `${d.toLocaleDateString([], {month: 'short', day: 'numeric'})} (${p})`;
        }
    </script>
</body>
</html>
