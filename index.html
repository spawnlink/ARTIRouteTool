<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trucking Weather Route Alert Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 2s linear infinite;
            display: inline-block;
            vertical-align: middle;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Ensure table layout is fixed to respect truncation */
        table { table-layout: fixed; width: 100%; border-collapse: collapse; }
        th, td { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen p-4 md:p-8 font-sans">

    <!-- Container updated to max-w-full to expand width-wise -->
    <div class="max-w-full mx-auto bg-white rounded-xl shadow-lg overflow-hidden border border-slate-200">
        <div class="bg-blue-900 p-6 text-white">
            <h1 class="text-3xl font-bold flex items-center gap-2">
                ðŸš€ Smart-Route Weather System
            </h1>
            <p class="text-blue-100 text-base mt-1 text-balance">Direct path analysis for trucking corridors. Fetches sequenced NWS alerts in order of travel.</p>
        </div>

        <div class="p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1 text-lg">Start City (e.g., Kalona, IA)</label>
                    <input type="text" id="startInput" placeholder="City, State" class="w-full border p-4 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none shadow-sm text-xl">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1 text-lg">End City (e.g., Dallas, TX)</label>
                    <input type="text" id="endInput" placeholder="City, State" class="w-full border p-4 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none shadow-sm text-xl">
                </div>
            </div>

            <button onclick="calculateAndCheck()" id="checkBtn" class="w-full bg-blue-700 hover:bg-blue-800 text-white font-bold py-5 px-6 rounded-xl shadow-lg transition flex items-center justify-center gap-2 text-2xl">
                <span>Analyze Route Alerts</span>
            </button>

            <!-- Status Console -->
            <div id="debugLog" class="mt-4 p-3 bg-black text-green-400 text-xs font-mono rounded-lg h-24 overflow-y-auto hidden">
                <div class="mb-1 text-white border-b border-gray-700 pb-1 font-bold">Trip Analysis Progress:</div>
                <div id="logLines"></div>
            </div>

            <div id="loading" class="hidden mt-6 p-6 bg-blue-50 text-blue-700 rounded-xl text-center border border-blue-100">
                <div class="loader mr-3"></div> 
                <span id="loadingText" class="font-bold text-xl">Mapping corridor and fetching live weather data...</span>
            </div>

            <div id="routeSummary" class="hidden mt-6 mb-4 p-4 bg-slate-50 border rounded-lg flex flex-wrap gap-2 items-center text-lg text-slate-600">
                <span class="font-bold text-slate-800">Planned Corridor:</span>
                <div id="pathDisplay" class="flex flex-wrap gap-1 items-center"></div>
            </div>

            <div id="resultsArea" class="hidden">
                <div class="mb-4 flex justify-between items-center border-b pb-1">
                    <h2 class="text-2xl font-bold text-gray-800">Sequenced Trip Alerts</h2>
                    <span id="timestamp" class="text-sm text-gray-500 italic"></span>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="bg-slate-100 border-b-2 border-slate-200">
                                <th class="p-2 text-xs font-black uppercase tracking-widest text-slate-500 w-16 text-lg">St</th>
                                <th class="p-2 text-xs font-black uppercase tracking-widest text-slate-500 w-48 text-lg">City</th>
                                <th class="p-2 text-xs font-black uppercase tracking-widest text-slate-500 w-40 text-lg text-center">Type</th>
                                <th class="p-2 text-xs font-black uppercase tracking-widest text-slate-500 w-64 text-lg">Timing</th>
                                <th class="p-2 text-xs font-black uppercase tracking-widest text-slate-500 text-lg">Hazard Details</th>
                            </tr>
                        </thead>
                        <tbody id="alertTableBody">
                            <!-- Results inject here -->
                        </tbody>
                    </table>
                </div>
                <div id="noAlerts" class="hidden p-16 text-center text-gray-500 italic bg-slate-50 rounded-xl mt-4 border-2 border-dashed">
                    No severe winter alerts found for this specific corridor at this time.
                </div>
            </div>
        </div>

        <div class="bg-slate-50 p-4 text-[10px] text-gray-400 text-center uppercase tracking-widest">
            Direct Path Vector Mapping â€¢ Official NWS Data Stream
        </div>
    </div>

    <script>
        function log(msg, isError = false) {
            console.log(`[TRIP] ${msg}`);
            const logBox = document.getElementById('debugLog');
            const lines = document.getElementById('logLines');
            logBox.classList.remove('hidden');
            const entry = document.createElement('div');
            entry.style.color = isError ? '#ff6b6b' : '#4ade80';
            entry.innerText = `> ${msg}`;
            lines.appendChild(entry);
            logBox.scrollTop = logBox.scrollHeight;
        }

        const hubs = [
            // Midwest
            { name: "Kalona/Iowa City, IA", state: "IA", lat: 41.66, lon: -91.53 },
            { name: "Des Moines, IA", state: "IA", lat: 41.58, lon: -93.60 },
            { name: "Davenport, IA", state: "IA", lat: 41.52, lon: -90.57 },
            { name: "Kansas City, MO", state: "MO", lat: 39.09, lon: -94.57 },
            { name: "St. Louis, MO", state: "MO", lat: 38.62, lon: -90.19 },
            { name: "Springfield, MO", state: "MO", lat: 37.20, lon: -93.29 },
            { name: "Joplin, MO", state: "MO", lat: 37.08, lon: -94.51 },
            // South Central / Plains
            { name: "Oklahoma City, OK", state: "OK", lat: 35.46, lon: -97.51 },
            { name: "Tulsa, OK", state: "OK", lat: 36.15, lon: -95.99 },
            { name: "McAlester, OK", state: "OK", lat: 34.93, lon: -95.76 },
            { name: "Dallas/Fort Worth, TX", state: "TX", lat: 32.77, lon: -96.79 },
            { name: "Denton, TX", state: "TX", lat: 33.21, lon: -97.13 },
            { name: "Shreveport, LA", state: "LA", lat: 32.52, lon: -93.75 },
            { name: "Texarkana, TX/AR", state: "AR", lat: 33.42, lon: -94.04 },
            { name: "Little Rock, AR", state: "AR", lat: 34.74, lon: -92.28 },
            { name: "Wichita, KS", state: "KS", lat: 37.68, lon: -97.33 },
            // Southeast
            { name: "Memphis, TN", state: "TN", lat: 35.14, lon: -90.04 },
            { name: "Nashville, TN", state: "TN", lat: 36.16, lon: -86.78 },
            { name: "Atlanta, GA", state: "GA", lat: 33.74, lon: -84.38 },
            { name: "Birmingham, AL", state: "AL", lat: 33.51, lon: -86.81 },
            { name: "Jackson, MS", state: "MS", lat: 32.29, lon: -90.18 },
            // Others
            { name: "Chicago, IL", state: "IL", lat: 41.87, lon: -87.62 },
            { name: "Indianapolis, IN", state: "IN", lat: 39.76, lon: -86.15 },
            { name: "Omaha, NE", state: "NE", lat: 41.25, lon: -95.93 },
            { name: "Denver, CO", state: "CO", lat: 39.73, lon: -104.99 }
        ];

        async function calculateAndCheck() {
            const startVal = document.getElementById('startInput').value.trim();
            const endVal = document.getElementById('endInput').value.trim();
            
            if (!startVal || !endVal) {
                alert("Please enter both locations.");
                return;
            }

            const loading = document.getElementById('loading');
            const resultsArea = document.getElementById('resultsArea');
            const tableBody = document.getElementById('alertTableBody');
            const routeSummary = document.getElementById('routeSummary');
            const pathDisplay = document.getElementById('pathDisplay');
            const logLines = document.getElementById('logLines');

            logLines.innerHTML = '';
            loading.classList.remove('hidden');
            resultsArea.classList.add('hidden');
            routeSummary.classList.add('hidden');
            tableBody.innerHTML = '';
            pathDisplay.innerHTML = '';

            try {
                log(`Starting analysis for: ${startVal} to ${endVal}`);
                const startHub = findNearestHub(startVal);
                const endHub = findNearestHub(endVal);

                if (!startHub || !endHub) {
                    const missing = !startHub ? startVal : endVal;
                    log(`Error: Could not locate hub for "${missing}"`, true);
                    alert(`Could not find a major hub for "${missing}". Try typing a larger city or the state code.`);
                    return;
                }

                log(`Hubs found: ${startHub.name} to ${endHub.name}`);

                if (startHub.name === endHub.name) {
                    log("Error: Start and destination resolved to the same location.", true);
                    alert("Start and end locations are too close. Please choose distinct hubs.");
                    return;
                }

                log("Calculating vector projection for corridor...");
                const routeCities = determineCorridor(startHub, endHub);
                log(`Path identified: ${routeCities.length} major segments.`);
                
                routeCities.forEach((c, i) => {
                    const span = document.createElement('span');
                    span.className = "bg-blue-100 text-blue-800 px-3 py-1 rounded text-base font-bold border border-blue-200";
                    span.innerText = c.name;
                    pathDisplay.appendChild(span);
                    if (i < routeCities.length - 1) {
                        pathDisplay.innerHTML += `<span class="text-slate-400 mx-1">â†’</span>`;
                    }
                });
                routeSummary.classList.remove('hidden');

                // Mapping of state to list of cities in that state along the route
                const stateCityMap = {};
                routeCities.forEach(c => {
                    if (!stateCityMap[c.state]) stateCityMap[c.state] = [];
                    stateCityMap[c.state].push(c.name.split('/')[0]);
                });

                const stateSequence = [...new Set(routeCities.map(c => c.state))];
                log(`Fetching alerts for states: ${stateSequence.join(', ')}`);
                
                const seenAlerts = new Set();
                let alertsFound = false;

                for (const state of stateSequence) {
                    log(`Polling NWS for ${state}...`);
                    try {
                        const response = await fetch(`https://api.weather.gov/alerts/active?area=${state}`);
                        const data = await response.json();

                        if (data.features) {
                            const filtered = data.features.filter(f => {
                                const e = f.properties.event.toLowerCase();
                                return e.includes('winter') || e.includes('ice') || e.includes('snow') || e.includes('cold') || e.includes('blizzard') || e.includes('sleet');
                            });

                            log(`Found ${filtered.length} relevant alerts in ${state}`);

                            filtered.forEach(alert => {
                                const key = `${state}-${alert.properties.event}-${alert.properties.headline}`;
                                if (!seenAlerts.has(key)) {
                                    seenAlerts.add(key);
                                    alertsFound = true;
                                    // Associate with the first hub found in this state on the route
                                    const primaryCity = stateCityMap[state][0] || "";
                                    appendRow(state, primaryCity, alert, tableBody);
                                }
                            });
                        }
                    } catch (e) {
                        log(`Warning: Failed to fetch data for ${state}. Skipping.`, true);
                    }
                }

                document.getElementById('timestamp').innerText = `Updated: ${new Date().toLocaleTimeString()}`;
                if (!alertsFound) {
                    log("Complete: No severe winter alerts active for this corridor.");
                    document.getElementById('noAlerts').classList.remove('hidden');
                } else {
                    log("Complete: Alerts loaded.");
                    document.getElementById('noAlerts').classList.add('hidden');
                }
                
                resultsArea.classList.remove('hidden');

            } catch (err) {
                log(`Critical Failure: ${err.message}`, true);
                alert("An error occurred during calculation. Check the logs.");
            } finally {
                loading.classList.add('hidden');
            }
        }

        function findNearestHub(input) {
            const clean = input.toLowerCase();
            const stateMatch = input.match(/\b([A-Z]{2})\b/i);
            const stateCode = stateMatch ? stateMatch[1].toUpperCase() : null;

            let match = hubs.find(h => clean === h.name.toLowerCase() || (stateCode && clean.includes(h.name.toLowerCase().split('/')[0])));
            
            if (!match && stateCode) {
                match = hubs.find(h => h.state === stateCode);
            }

            if (!match) {
                match = hubs.find(h => clean.includes(h.name.toLowerCase().split('/')[0]));
            }

            return match;
        }

        function determineCorridor(start, end) {
            const vx = end.lon - start.lon;
            const vy = end.lat - start.lat;
            const magSq = vx * vx + vy * vy;

            let corridor = hubs.map(h => {
                const hx = h.lon - start.lon;
                const hy = h.lat - start.lat;
                const t = (hx * vx + hy * vy) / magSq;
                const projX = start.lon + t * vx;
                const projY = start.lat + t * vy;
                const perpDist = Math.sqrt(Math.pow(h.lon - projX, 2) + Math.pow(h.lat - projY, 2));
                return { ...h, t, perpDist };
            });

            corridor = corridor.filter(h => h.t >= -0.05 && h.t <= 1.05 && h.perpDist < 2.0);
            corridor.sort((a, b) => a.t - b.t);

            const final = [];
            const seen = new Set();
            corridor.forEach(c => {
                if(!seen.has(c.name)) {
                    seen.add(c.name);
                    final.push(c);
                }
            });

            if (final.length > 7) {
                const step = (final.length - 1) / 6;
                const pruned = [];
                for(let i=0; i<7; i++) {
                    pruned.push(final[Math.round(i * step)]);
                }
                return pruned;
            }

            return final;
        }

        function appendRow(state, city, alert, tbody) {
            // Clean headline to remove redundant time/date info
            const rawHeadline = alert.properties.headline || '';
            const cleanHeadline = rawHeadline
                .split('...')[0]
                .replace(/(IN EFFECT|REMAINS IN EFFECT|FROM|UNTIL|THROUGH).*/gi, '')
                .trim();

            const row = document.createElement('tr');
            row.className = "border-b border-slate-200 hover:bg-slate-50 transition";
            row.innerHTML = `
                <td class="p-2 font-black text-blue-900 align-middle text-2xl">${state}</td>
                <td class="p-2 font-bold text-slate-800 align-middle text-xl overflow-hidden text-ellipsis whitespace-nowrap">${city}</td>
                <td class="p-2 align-middle">
                    <span class="px-2 py-0.5 rounded text-[10px] font-black uppercase tracking-tighter block text-center ${getBadgeColor(alert.properties.event)}">
                        ${alert.properties.event}
                    </span>
                </td>
                <td class="p-2 text-xl align-middle text-slate-700 font-bold leading-none">
                    <div class="uppercase tracking-tight"><span class="text-slate-400 mr-2 text-[10px] uppercase">Starts</span> ${formatDate(alert.properties.effective)}</div>
                    <div class="uppercase tracking-tight mt-1"><span class="text-slate-400 mr-2 text-[10px] uppercase">Ends</span> ${formatDate(alert.properties.ends || alert.properties.expires)}</div>
                </td>
                <td class="p-2 align-middle">
                    <div class="flex items-center gap-3 overflow-hidden">
                         <a href="https://forecast.weather.gov/showsigwx.php?product=${alert.properties.id}" target="_blank" class="bg-slate-800 text-white px-3 py-1.5 rounded text-[10px] font-bold uppercase tracking-widest hover:bg-blue-600 transition shadow-md shrink-0">View</a>
                         <p class="font-bold text-slate-800 text-xl overflow-hidden text-ellipsis whitespace-nowrap" title="${rawHeadline.replace(/"/g, '&quot;')}">
                            ${cleanHeadline || rawHeadline}
                         </p>
                    </div>
                </td>
            `;
            tbody.appendChild(row);
        }

        function getBadgeColor(event) {
            const e = event.toLowerCase();
            if (e.includes('warning')) return 'bg-red-600 text-white';
            if (e.includes('watch')) return 'bg-orange-500 text-white';
            return 'bg-blue-600 text-white';
        }

        function formatDate(str) {
            if (!str) return "--";
            const d = new Date(str);
            const hour = d.getHours();
            let period = "Night";
            
            if (hour >= 5 && hour < 12) period = "Morning";
            else if (hour >= 12 && hour < 17) period = "Noon";
            
            const datePart = d.toLocaleDateString([], {month: 'short', day: 'numeric'});
            return `${datePart} (${period})`;
        }
    </script>
</body>
</html>
