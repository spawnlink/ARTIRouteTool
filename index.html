<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trucking Weather Route Alert Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Leaflet Map CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <!-- Leaflet Map JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <style>
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 2s linear infinite;
            display: inline-block;
            vertical-align: middle;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Ensure table layout is fixed to respect truncation */
        table { table-layout: fixed; width: 100%; border-collapse: collapse; }
        th, td { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        
        #map {
            height: 450px;
            width: 100%;
            border-radius: 0.75rem;
            border: 1px solid #e2e8f0;
            z-index: 10;
        }

        .cat-badge {
            background-color: #f59e0b;
            color: white;
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 900;
            text-transform: uppercase;
            margin-left: 6px;
            display: inline-block;
            vertical-align: middle;
            box-shadow: 0 1px 2px rgba(0,0,0,0.15);
            border: 1px solid #d97706;
        }

        .nearest-cat-row {
            background-color: #fffbeb !important; /* Soft amber */
            border-left: 10px solid #f59e0b !important;
            box-shadow: inset 0 0 10px rgba(245, 158, 11, 0.05);
        }

        .road-label {
            font-size: 10px;
            font-weight: bold;
            color: #1e40af;
            text-transform: uppercase;
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen p-4 md:p-8 font-sans">

    <!-- Full-width Container -->
    <div class="max-w-full mx-auto bg-white rounded-xl shadow-lg overflow-hidden border border-slate-200">
        <div class="bg-blue-900 p-6 text-white">
            <h1 class="text-3xl font-bold flex items-center gap-2">
                üöÄ Smart-Route Weather System
            </h1>
            <p class="text-blue-100 text-base mt-1 text-balance">Highway corridor analysis. Uses OSRM for interstate routing with integrated CAT scale & weather detection.</p>
        </div>

        <div class="p-6">
            <div id="dataLoadingStatus" class="mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg text-yellow-800 font-medium text-sm flex items-center gap-3">
                <div class="loader !w-4 !h-4 !border-2"></div>
                Initializing cloud city database and CAT scale locations...
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1 text-lg">Start City (e.g., Kalona, IA)</label>
                    <input type="text" id="startInput" placeholder="City, State" class="w-full border p-4 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none shadow-sm text-xl">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1 text-lg">End City (e.g., Denver, CO)</label>
                    <input type="text" id="endInput" placeholder="City, State" class="w-full border p-4 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none shadow-sm text-xl">
                </div>
            </div>

            <button onclick="calculateAndCheck()" id="checkBtn" disabled class="w-full bg-blue-700 hover:bg-blue-800 disabled:bg-slate-300 disabled:cursor-not-allowed text-white font-bold py-5 px-6 rounded-xl shadow-lg transition flex items-center justify-center gap-2 text-2xl">
                <span id="btnText">Loading Database...</span>
            </button>

            <!-- Status Console -->
            <div id="debugLog" class="mt-4 p-3 bg-black text-green-400 text-xs font-mono rounded-lg h-24 overflow-y-auto hidden">
                <div class="mb-1 text-white border-b border-gray-700 pb-1 font-bold">Logistics Analysis Progress:</div>
                <div id="logLines"></div>
            </div>

            <div id="loading" class="hidden mt-6 p-6 bg-blue-50 text-blue-700 rounded-xl text-center border border-blue-100">
                <div class="loader mr-3"></div> 
                <span id="loadingText" class="font-bold text-xl">Mapping highway geometry and polling weather services...</span>
            </div>

            <div id="routeSummary" class="hidden mt-6 mb-4 p-4 bg-slate-50 border rounded-lg flex flex-wrap gap-2 items-center text-lg text-slate-600">
                <span class="font-bold text-slate-800">Highway Path:</span>
                <div id="pathDisplay" class="flex flex-wrap gap-1 items-center"></div>
            </div>

            <div id="resultsArea" class="hidden">
                <div class="mb-4 flex justify-between items-center border-b pb-1">
                    <h2 class="text-2xl font-bold text-gray-800">Operational Trip Report</h2>
                    <span id="timestamp" class="text-sm text-gray-500 italic"></span>
                </div>

                <div class="overflow-x-auto mb-8">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="bg-slate-100 border-b-2 border-slate-200">
                                <th class="p-2 text-xs font-black uppercase tracking-widest text-slate-500 w-28 text-lg">State</th>
                                <th class="p-2 text-xs font-black uppercase tracking-widest text-slate-500 w-48 text-lg">City</th>
                                <th class="p-2 text-xs font-black uppercase tracking-widest text-slate-500 w-40 text-lg text-center">Type</th>
                                <th class="p-2 text-xs font-black uppercase tracking-widest text-slate-500 w-64 text-lg">Timing</th>
                                <th class="p-2 text-xs font-black uppercase tracking-widest text-slate-500 text-lg">Hazard Details</th>
                            </tr>
                        </thead>
                        <tbody id="alertTableBody">
                            <!-- Results inject here -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Map Visualization -->
                <div id="mapSection" class="mt-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Road Map Visualizer</h3>
                    <div id="map" class="shadow-inner"></div>
                    <div class="flex justify-center gap-6 mt-3 text-xs">
                        <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-[#10b981]"></span> Start</div>
                        <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-[#ef4444]"></span> Destination</div>
                        <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-[#3b82f6]"></span> Hub Point</div>
                        <div class="flex items-center gap-1"><span class="text-blue-600 font-bold">‚îÅ</span> Interstate Route</div>
                    </div>
                </div>

                <div id="noAlerts" class="hidden p-16 text-center text-gray-500 italic bg-slate-50 rounded-xl mt-4 border-2 border-dashed">
                    No active NWS alerts found along this highway corridor.
                </div>
            </div>
        </div>

        <div class="bg-slate-50 p-4 text-[10px] text-gray-400 text-center uppercase tracking-widest">
            Interstate Logic via OSRM ‚Ä¢ NWS Point APIs ‚Ä¢ CAT Scale Enroute Optimization
        </div>
    </div>

    <script>
        let map = null;
        let routeLayer = null;
        let markerLayer = null;
        let hubs = []; 

        const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQCgGN8rGTUO3hN-b2QKMe3cLchE_45Y-xfsFciJc-YJ_NJ-Z3_TZSMzRV2Jthc-FYGpnQoycZmvVpv/pub?gid=0&single=true&output=csv";

        window.onload = async () => {
            await loadCityData();
        };

        // Advanced CSV Parser to handle quotes/commas correctly
        function parseCSVLine(line) {
            const result = [];
            let cell = '';
            let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(cell);
                    cell = '';
                } else {
                    cell += char;
                }
            }
            result.push(cell);
            return result;
        }

        async function loadCityData() {
            const statusEl = document.getElementById('dataLoadingStatus');
            const checkBtn = document.getElementById('checkBtn');
            const btnText = document.getElementById('btnText');

            try {
                const response = await fetch(csvUrl);
                if (!response.ok) throw new Error("Failed to reach database");
                const csvText = await response.text();
                
                const lines = csvText.split(/\r?\n/);
                const midwestStates = ['IA', 'WI', 'MN', 'NE', 'MO', 'IL'];
                
                hubs = lines.slice(1).map(line => {
                    if (!line.trim()) return null;
                    const parts = parseCSVLine(line);
                    if (parts.length < 5) return null;
                    
                    const name = parts[0].trim();
                    const state = parts[1].trim();
                    const lat = parseFloat(parts[2]);
                    const lon = parseFloat(parts[3]);
                    const pop = parseInt(parts[4]) || 0;
                    const isCatScale = parts[5] ? (parts[5].toLowerCase().includes('yes') || parts[5].trim() === '1') : false;

                    // UPDATED LOGIC: If it's a CAT Scale, include it REGARDLESS of population or state
                    if (isCatScale) {
                        return { name, state, lat, lon, pop, isCatScale };
                    }

                    // Otherwise apply standard population rules
                    if (midwestStates.includes(state) || pop >= 1000) {
                        return { name, state, lat, lon, pop, isCatScale };
                    }
                    return null;
                }).filter(h => h !== null);

                statusEl.innerHTML = `‚úÖ Network Sync: ${hubs.length.toLocaleString()} locations loaded.`;
                statusEl.className = "mb-6 p-4 bg-green-50 border border-green-200 rounded-lg text-green-800 font-medium text-sm flex items-center gap-3";
                
                checkBtn.disabled = false;
                btnText.innerText = "Analyze Route Alerts";
            } catch (err) {
                log(`Database Error: ${err.message}`, true);
                checkBtn.disabled = false;
                btnText.innerText = "Analyze Route (Static Mode)";
            }
        }

        function log(msg, isError = false) {
            console.log(`[LOG] ${msg}`);
            const logBox = document.getElementById('debugLog');
            const lines = document.getElementById('logLines');
            logBox.classList.remove('hidden');
            const entry = document.createElement('div');
            entry.style.color = isError ? '#ff6b6b' : '#4ade80';
            entry.innerText = `> ${msg}`;
            lines.appendChild(entry);
            logBox.scrollTop = logBox.scrollHeight;
        }

        async function geocode(location) {
            log(`Geocoding: ${location}...`);
            const manualStateMatch = location.match(/\b([A-Z]{2})\b/i);
            const stateCode = manualStateMatch ? manualStateMatch[1].toUpperCase() : null;

            try {
                // Force state search to avoid resolving to incorrect states (Denver IA vs Denver CO)
                const query = stateCode ? `${location}` : location;
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=us&limit=1`, { 
                    headers: { 'Accept': 'application/json' }
                });
                const data = await response.json();
                if (data && data.length > 0) {
                    const res = data[0];
                    return {
                        name: location.split(',')[0].trim(),
                        state: stateCode || "US",
                        lat: parseFloat(res.lat),
                        lon: parseFloat(res.lon)
                    };
                }
            } catch (err) { log(`Geocoder Service Error: ${err.message}`, true); }

            // Local fallback
            const cityPart = location.split(',')[0].toLowerCase().trim();
            let localHub = hubs.find(h => h.name.toLowerCase() === cityPart && (!stateCode || h.state === stateCode));
            if (localHub) return { ...localHub };
            return null;
        }

        function initMap() {
            if (!map) {
                map = L.map('map').setView([39.8283, -98.5795], 4);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; OpenStreetMap'
                }).addTo(map);
                routeLayer = L.layerGroup().addTo(map);
                markerLayer = L.layerGroup().addTo(map);
            }
        }

        async function calculateAndCheck() {
            const startStr = document.getElementById('startInput').value.trim();
            const endStr = document.getElementById('endInput').value.trim();
            if (!startStr || !endStr) return;

            const loading = document.getElementById('loading');
            const resultsArea = document.getElementById('resultsArea');
            const tableBody = document.getElementById('alertTableBody');
            const routeSummary = document.getElementById('routeSummary');
            const pathDisplay = document.getElementById('pathDisplay');

            loading.classList.remove('hidden');
            resultsArea.classList.add('hidden');
            routeSummary.classList.add('hidden');
            tableBody.innerHTML = '';
            pathDisplay.innerHTML = '';
            document.getElementById('logLines').innerHTML = '';

            try {
                const startPoint = await geocode(startStr);
                const endPoint = await geocode(endStr);
                if (!startPoint || !endPoint) throw new Error("Start or Destination city not found.");

                log(`Calculating Interstate Route: ${startPoint.name} to ${endPoint.name}...`);
                const osrmUrl = `https://router.project-osrm.org/route/v1/driving/${startPoint.lon},${startPoint.lat};${endPoint.lon},${endPoint.lat}?overview=full&geometries=geojson`;
                const osrmResponse = await fetch(osrmUrl);
                const osrmData = await osrmResponse.json();

                if (!osrmData.routes || osrmData.routes.length === 0) throw new Error("No highway path identified.");

                const routeGeometry = osrmData.routes[0].geometry;
                const roadPoints = routeGeometry.coordinates;

                log("Filtering transit hubs along road path...");
                const analysis = findHubsAlongPath(roadPoints, startPoint, endPoint);
                const corridorHubs = analysis.corridor;
                const nearestScale = analysis.nearestCatScale;

                // Build Deduplicated Hub List for Table/Weather
                let tablePoints = [startPoint, ...corridorHubs, endPoint];
                const uniqueTablePoints = [];
                const seenKeys = new Set();
                tablePoints.forEach(p => {
                    const key = `${p.name.toLowerCase()}-${p.state.toLowerCase()}`;
                    if (!seenKeys.has(key)) {
                        seenKeys.add(key);
                        uniqueTablePoints.push(p);
                    }
                });

                // Display Path Icons
                uniqueTablePoints.forEach((c, i) => {
                    const span = document.createElement('span');
                    span.className = `bg-blue-100 text-blue-800 px-3 py-1 rounded text-base font-bold border border-blue-200`;
                    span.innerText = c.name;
                    pathDisplay.appendChild(span);
                    if (i < uniqueTablePoints.length - 1) pathDisplay.innerHTML += `<span class="text-slate-400 mx-1">‚Üí</span>`;
                });
                routeSummary.classList.remove('hidden');

                initMap();
                drawRoadMap(routeGeometry, uniqueTablePoints);

                // PROCESS REPORT TABLE
                // USER RULE: Put nearest scale at the VERY TOP
                if (nearestScale) {
                    log(`Detected nearest enroute CAT Scale: ${nearestScale.name}, ${nearestScale.state}`);
                    await processTableRow(nearestScale, tableBody, true);
                }

                for (let i = 0; i < uniqueTablePoints.length; i++) {
                    const isEndpoint = (i === 0 || i === uniqueTablePoints.length - 1);
                    await processTableRow(uniqueTablePoints[i], tableBody, false, isEndpoint);
                }

                document.getElementById('timestamp').innerText = `Updated: ${new Date().toLocaleTimeString()}`;
                resultsArea.classList.remove('hidden');
                setTimeout(() => map.invalidateSize(), 200);

            } catch (err) {
                log(`Analysis Error: ${err.message}`, true);
            } finally {
                loading.classList.add('hidden');
            }
        }

        async function processTableRow(point, tbody, isScaleRow, isEndpoint = false) {
            log(`Polling weather for ${point.name}...`);
            let reportsFound = false;
            try {
                const response = await fetch(`https://api.weather.gov/alerts/active?point=${point.lat},${point.lon}`);
                const data = await response.json();

                if (data.features && data.features.length > 0) {
                    const filtered = data.features.filter(f => {
                        const e = f.properties.event.toLowerCase();
                        return e.includes('winter') || e.includes('ice') || e.includes('snow') || e.includes('cold') || 
                               e.includes('blizzard') || e.includes('sleet') || e.includes('wind') || e.includes('chill');
                    });

                    if (filtered.length > 0) {
                        reportsFound = true;
                        filtered.forEach(alert => {
                            appendRow(point, alert, tbody, isScaleRow);
                        });
                    }
                }
            } catch (e) { log(`Weather poll failed for ${point.name}`, true); }

            if (!reportsFound && (isScaleRow || isEndpoint)) {
                appendEmptyRow(point, tbody, isScaleRow);
            }
        }

        /**
         * Select hubs based on highway proximity
         */
        function findHubsAlongPath(roadCoords, start, end) {
            // Increase search resolution for highway exits
            const sampleRate = Math.max(1, Math.floor(roadCoords.length / 80));
            const sampledPath = roadCoords.filter((_, i) => i % sampleRate === 0);
            sampledPath.push(roadCoords[roadCoords.length - 1]);

            const foundHubs = [];
            const seenHubs = new Set();
            let nearestScale = null;
            let minScaleDist = Infinity;

            hubs.forEach(h => {
                let minDist = Infinity;
                let roadIdx = -1;
                
                sampledPath.forEach((rp, idx) => {
                    const d = Math.sqrt(Math.pow(h.lon - rp[0], 2) + Math.pow(h.lat - rp[1], 2));
                    if (d < minDist) {
                        minDist = d;
                        roadIdx = idx;
                    }
                });

                // Proximity threshold ~35 miles from road (0.5 degrees)
                // This tight corridor ensures we only pick up scales truly ON THE ROUTE
                if (minDist < 0.5) {
                    const key = `${h.name.toLowerCase()}-${h.state.toLowerCase()}`;
                    
                    // Track nearest scale from start
                    if (h.isCatScale && roadIdx < minScaleDist) {
                        minScaleDist = roadIdx;
                        nearestScale = { ...h };
                    }

                    // Only add non-scale hubs or significant scales to the corridor report to keep it clean
                    if (!seenHubs.has(key) && !h.isCatScale) {
                        seenHubs.add(key);
                        foundHubs.push({ ...h, roadProg: roadIdx });
                    }
                }
            });

            foundHubs.sort((a, b) => a.roadProg - b.roadProg);

            // Limit intermediate hubs to 6 for clarity
            let pruned = foundHubs;
            if (foundHubs.length > 6) {
                const step = (foundHubs.length - 1) / 5;
                pruned = [];
                for(let i=0; i<6; i++) pruned.push(foundHubs[Math.round(i * step)]);
            }

            return { corridor: pruned, nearestCatScale: nearestScale };
        }

        function drawRoadMap(geo, transitPoints) {
            routeLayer.clearLayers();
            markerLayer.clearLayers();

            L.geoJSON(geo, {
                style: { color: '#2563eb', weight: 6, opacity: 0.8 }
            }).addTo(routeLayer);

            transitPoints.forEach((p, i) => {
                const isStart = i === 0;
                const isEnd = i === transitPoints.length - 1;
                const color = isStart ? '#10b981' : (isEnd ? '#ef4444' : '#3b82f6');
                
                L.circleMarker([p.lat, p.lon], {
                    radius: isStart || isEnd ? 10 : 5,
                    fillColor: color,
                    color: "#fff",
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 1
                }).addTo(markerLayer).bindTooltip(isStart ? "START" : (isEnd ? "END" : p.name), { 
                    permanent: true, direction: 'top', offset: [0, -10] 
                });
            });

            map.fitBounds(L.latLngBounds(geo.coordinates.map(c => [c[1], c[0]])), { 
                padding: [100, 100], maxZoom: 5 
            });
        }

        function appendRow(hub, alert, tbody, isScaleRow) {
            const rawHeadline = alert.properties.headline || '';
            const cleanHeadline = rawHeadline.split('...')[0].replace(/(IN EFFECT|REMAINS IN EFFECT|FROM|UNTIL|THROUGH).*/gi, '').trim();
            const row = document.createElement('tr');
            row.className = `border-b border-slate-200 transition ${isScaleRow ? 'nearest-cat-row' : 'hover:bg-slate-50'}`;
            
            row.innerHTML = `
                <td class="p-2 font-black text-blue-900 align-middle text-2xl w-28 uppercase">${hub.state}</td>
                <td class="p-2 font-bold text-slate-800 align-middle text-xl overflow-hidden text-ellipsis whitespace-nowrap w-48">
                    ${hub.name}${isScaleRow ? '<span class="cat-badge">‚≠ê Nearest Scale</span>' : (hub.isCatScale ? '<span class="cat-badge">CAT</span>' : '')}
                </td>
                <td class="p-2 align-middle w-40">
                    <span class="px-2 py-0.5 rounded text-[10px] font-black uppercase tracking-tighter block text-center ${getBadgeColor(alert.properties.event)}">${alert.properties.event}</span>
                </td>
                <td class="p-2 text-xl align-middle text-slate-700 font-bold leading-none w-64">
                    <div class="uppercase tracking-tight"><span class="text-slate-400 mr-2 text-[10px] uppercase">Starts</span> ${formatDate(alert.properties.effective)}</div>
                    <div class="uppercase tracking-tight mt-1"><span class="text-slate-400 mr-2 text-[10px] uppercase">Ends</span> ${formatDate(alert.properties.ends || alert.properties.expires)}</div>
                </td>
                <td class="p-2 align-middle">
                    <div class="flex items-center gap-3 overflow-hidden">
                         <a href="https://forecast.weather.gov/MapClick.php?lat=${hub.lat}&lon=${hub.lon}" target="_blank" class="bg-slate-800 text-white px-3 py-1.5 rounded text-[10px] font-bold uppercase tracking-widest hover:bg-blue-600 transition shadow-md shrink-0">View Link</a>
                         <p class="font-bold text-slate-800 text-xl overflow-hidden text-ellipsis whitespace-nowrap" title="${rawHeadline.replace(/"/g, '&quot;')}">${cleanHeadline || rawHeadline}</p>
                    </div>
                </td>
            `;
            tbody.appendChild(row);
        }

        function appendEmptyRow(hub, tbody, isScaleRow) {
            const row = document.createElement('tr');
            row.className = `border-b border-slate-200 transition ${isScaleRow ? 'nearest-cat-row font-black' : 'bg-slate-50 opacity-75'}`;
            
            row.innerHTML = `
                <td class="p-2 font-black align-middle text-2xl w-28 uppercase ${isScaleRow ? 'text-amber-800' : 'text-slate-400'}">${hub.state}</td>
                <td class="p-2 font-bold align-middle text-xl w-48 ${isScaleRow ? 'text-amber-900' : 'text-slate-400'}">
                    ${hub.name}${isScaleRow ? '<span class="cat-badge">‚≠ê Nearest Scale</span>' : (hub.isCatScale ? '<span class="cat-badge">CAT</span>' : '')}
                </td>
                <td class="p-2 align-middle w-40 text-center">
                    <span class="px-2 py-0.5 rounded text-[10px] font-black uppercase tracking-tighter ${isScaleRow ? 'bg-amber-600 text-white' : 'bg-slate-200 text-slate-500'}">
                        ${isScaleRow ? 'Operational' : 'None'}
                    </span>
                </td>
                <td class="p-2 text-xl align-middle font-medium w-64 italic ${isScaleRow ? 'text-amber-700' : 'text-slate-400'}">
                    ${isScaleRow ? 'Priority Scale Point' : 'Clear Conditions'}
                </td>
                <td class="p-2 align-middle">
                    <div class="flex items-center gap-3 overflow-hidden">
                         <a href="https://forecast.weather.gov/MapClick.php?lat=${hub.lat}&lon=${hub.lon}" target="_blank" class="px-3 py-1.5 rounded text-[10px] font-bold uppercase tracking-widest transition shadow-sm shrink-0 ${isScaleRow ? 'bg-amber-700 text-white hover:bg-amber-800' : 'bg-slate-300 text-slate-600 hover:bg-slate-400'}">View</a>
                         <p class="${isScaleRow ? 'text-amber-800 font-bold' : 'text-slate-400'} text-xl italic">
                            ${isScaleRow ? 'Scale Location: No Active Weather Advisories' : 'No reports issued on this line'}
                         </p>
                    </div>
                </td>
            `;
            tbody.appendChild(row);
        }

        function getBadgeColor(event) {
            const e = event.toLowerCase();
            if (e.includes('warning')) return 'bg-red-600 text-white';
            if (e.includes('watch')) return 'bg-orange-500 text-white';
            return 'bg-blue-600 text-white';
        }

        function formatDate(str) {
            if (!str) return "--";
            const d = new Date(str);
            const hour = d.getHours();
            let period = "Night";
            if (hour >= 5 && hour < 12) period = "Morning";
            else if (hour >= 12 && hour < 17) period = "Noon";
            const datePart = d.toLocaleDateString([], {month: 'short', day: 'numeric'});
            return `${datePart} (${period})`;
        }
    </script>
</body>
</html>
