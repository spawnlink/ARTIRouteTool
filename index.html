<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartRoute - Logistics & Weather Engine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Leaflet Map CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <!-- Leaflet Map JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <style>
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 2s linear infinite;
            display: inline-block;
            vertical-align: middle;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        table { table-layout: fixed; width: 100%; border-collapse: collapse; }
        th, td { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        
        #map {
            height: 550px;
            width: 100%;
            border-radius: 0.75rem;
            border: 1px solid #e2e8f0;
            z-index: 10;
        }

        .cat-badge {
            background-color: #f59e0b;
            color: white;
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 900;
            text-transform: uppercase;
            margin-left: 6px;
            display: inline-block;
            vertical-align: middle;
            box-shadow: 0 1px 2px rgba(0,0,0,0.15);
            border: 1px solid #d97706;
        }

        .nearest-cat-row {
            background-color: #fffbeb !important;
            border-left: 10px solid #f59e0b !important;
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen p-4 md:p-8 font-sans text-slate-900">

    <div class="max-w-full mx-auto bg-white rounded-xl shadow-lg overflow-hidden border border-slate-200">
        <div class="bg-blue-900 p-6 text-white">
            <h1 class="text-3xl font-bold flex items-center gap-2">
                üöÄ SmartRoute
            </h1>
            <p class="text-blue-100 text-base mt-1">Multi-Stop Dispatch Engine: 50mi Origin Scale Radius, 4mi Toll Net, and 200mi Weather Intervals.</p>
        </div>

        <div class="p-6">
            <div id="dataLoadingStatus" class="mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg text-yellow-800 font-medium text-sm flex items-center gap-3">
                <div class="loader !w-4 !h-4 !border-2"></div>
                Initializing global logistics and infrastructure databases...
            </div>

            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Pick Up (Start)</label>
                    <input type="text" id="startInput" placeholder="City, State" class="w-full border p-3 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none shadow-sm">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Stop 1 (Optional)</label>
                    <input type="text" id="stop1Input" placeholder="City, State" class="w-full border p-3 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none shadow-sm">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Stop 2 (Optional)</label>
                    <input type="text" id="stop2Input" placeholder="City, State" class="w-full border p-3 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none shadow-sm">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Delivery (End)</label>
                    <input type="text" id="endInput" placeholder="City, State" class="w-full border p-3 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none shadow-sm">
                </div>
            </div>

            <button onclick="calculateAndCheck()" id="checkBtn" disabled class="w-full bg-blue-700 hover:bg-blue-800 disabled:bg-slate-300 disabled:cursor-not-allowed text-white font-bold py-5 px-6 rounded-xl shadow-lg transition flex items-center justify-center gap-2 text-2xl">
                <span id="btnText">Syncing Data...</span>
            </button>

            <!-- Debug Window -->
            <div id="debugLog" class="mt-4 p-3 bg-black text-green-400 text-xs font-mono rounded-lg h-24 overflow-y-auto hidden">
                <div id="logLines"></div>
            </div>

            <div id="loading" class="hidden mt-6 p-6 bg-blue-50 text-blue-700 rounded-xl text-center border border-blue-100">
                <div class="loader mr-3"></div> 
                <span id="loadingText" class="font-bold text-xl">Recalculating highway geometry and intersecting toll gantries...</span>
            </div>

            <div id="routeSummary" class="hidden mt-6 mb-4 p-4 bg-slate-50 border rounded-lg flex flex-wrap gap-2 items-center text-lg text-slate-600">
                <span class="font-bold text-slate-800">Operational Chain:</span>
                <div id="pathDisplay" class="flex flex-wrap gap-1 items-center"></div>
            </div>

            <!-- Toll Summary Section -->
            <div id="tollSection" class="hidden mb-6 bg-purple-50 border border-purple-200 rounded-lg p-4 shadow-sm">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-lg font-bold text-purple-900 flex items-center gap-2">
                        <span class="text-xl">üí∞</span> Cumulative Toll Summary (5-Axle)
                    </h3>
                    <span id="totalTollCost" class="bg-purple-600 text-white px-4 py-1.5 rounded-full text-lg font-bold"></span>
                </div>
                <div id="tollList" class="text-sm text-purple-800 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-x-4 gap-y-1 max-h-48 overflow-y-auto mt-2">
                </div>
            </div>

            <div id="resultsArea" class="hidden">
                <div class="mb-4 flex justify-between items-center border-b pb-1">
                    <h2 class="text-2xl font-bold text-gray-800">SmartRoute Operational Trip Report</h2>
                    <span id="timestamp" class="text-sm text-gray-500 italic"></span>
                </div>

                <div class="overflow-x-auto mb-8">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="bg-slate-100 border-b-2 border-slate-200">
                                <th class="p-2 text-xs font-black uppercase text-slate-500 w-28 text-lg">State</th>
                                <th class="p-2 text-xs font-black uppercase text-slate-500 w-48 text-lg">City</th>
                                <th class="p-2 text-xs font-black uppercase text-slate-500 w-40 text-lg text-center">Type</th>
                                <th class="p-2 text-xs font-black uppercase text-slate-500 w-64 text-lg">Timing</th>
                                <th class="p-2 text-xs font-black uppercase text-slate-500 text-lg">Hazard Details</th>
                            </tr>
                        </thead>
                        <tbody id="alertTableBody"></tbody>
                    </table>
                </div>
                
                <div id="mapSection" class="mt-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Infrastructure & Path Visualization</h3>
                    <div id="map" class="shadow-inner"></div>
                    <div class="flex justify-center gap-4 mt-3 text-xs flex-wrap">
                        <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-[#10b981]"></span> Pickup</div>
                        <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-[#ef4444]"></span> Delivery</div>
                        <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-[#2563eb]"></span> Intermediate Stop</div>
                        <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-[#3b82f6]"></span> Weather Hub</div>
                        <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-[#facc15] shadow-[0_0_5px_#facc15]"></span> Local Scale</div>
                        <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-[#a855f7]"></span> Toll Gantry</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let map = null;
        let routeLayer = null;
        let markerLayer = null;
        let hubs = []; 
        let tolls = [];

        const cityCsvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQCgGN8rGTUO3hN-b2QKMe3cLchE_45Y-xfsFciJc-YJ_NJ-Z3_TZSMzRV2Jthc-FYGpnQoycZmvVpv/pub?gid=0&single=true&output=csv";
        const tollCsvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQCgGN8rGTUO3hN-b2QKMe3cLchE_45Y-xfsFciJc-YJ_NJ-Z3_TZSMzRV2Jthc-FYGpnQoycZmvVpv/pub?gid=1793109645&single=true&output=csv";

        window.onload = async () => {
            await loadAllData();
            
            ['startInput', 'stop1Input', 'stop2Input', 'endInput'].forEach(id => {
                document.getElementById(id).addEventListener("keypress", (e) => {
                    if (e.key === "Enter") {
                        e.preventDefault();
                        if (!document.getElementById('checkBtn').disabled) calculateAndCheck();
                    }
                });
            });
        };

        function parseCSVLine(line) {
            const result = [];
            let cell = '';
            let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') inQuotes = !inQuotes;
                else if (char === ',' && !inQuotes) {
                    result.push(cell);
                    cell = '';
                } else cell += char;
            }
            result.push(cell);
            return result;
        }

        async function loadAllData() {
            const statusEl = document.getElementById('dataLoadingStatus');
            const checkBtn = document.getElementById('checkBtn');

            try {
                // 1. Load Cities
                const cityRes = await fetch(cityCsvUrl);
                const cityText = await cityRes.text();
                const cityLines = cityText.split(/\r?\n/).filter(l => l.trim().length > 0);
                
                hubs = cityLines.slice(1).map(line => {
                    const parts = parseCSVLine(line);
                    if (parts.length < 4) return null;
                    const name = parts[0].trim();
                    const state = parts[1].trim();
                    const lat = parseFloat(parts[2]);
                    const lon = parseFloat(parts[3]);
                    const pop = parseInt(parts[4]) || 0;
                    const isCatScale = parts[5] ? (parts[5].toLowerCase().includes('true') || parts[5].trim() === '1') : false;
                    return { name, state, lat, lon, pop, isCatScale };
                }).filter(h => h !== null && !isNaN(h.lat));

                // 2. Load Tolls
                const tollRes = await fetch(tollCsvUrl);
                const tollText = await tollRes.text();
                if (tollText) {
                    const tollLines = tollText.split(/\r?\n/).filter(l => l.trim().length > 0);
                    const headers = parseCSVLine(tollLines[0]).map(h => h.trim().toLowerCase());
                    
                    const latIdx = headers.findIndex(h => h.includes('lat'));
                    const lonIdx = headers.findIndex(h => h.includes('lon') || h.includes('lng') || h.includes('long'));
                    const nameIdx = headers.indexOf('name') !== -1 ? headers.indexOf('name') : (headers.indexOf('city') !== -1 ? headers.indexOf('city') : 0);
                    const rateIdx = headers.findIndex(h => h.includes('rate') || h.includes('price') || h.includes('cost') || h.includes('axle'));

                    tolls = tollLines.slice(1).map(line => {
                        const parts = parseCSVLine(line);
                        if (parts.length <= Math.max(latIdx, lonIdx)) return null;
                        const lat = parseFloat(parts[latIdx]);
                        const lon = parseFloat(parts[lonIdx]);
                        if (isNaN(lat) || isNaN(lon)) return null;
                        
                        const rawPrice = parts[rateIdx] || "0";
                        const price = parseFloat(rawPrice.replace(/[^0-9.]/g, '')) || 0;

                        return { name: parts[nameIdx]?.trim() || "Toll", lat, lon, price };
                    }).filter(t => t !== null);
                }

                statusEl.innerHTML = `‚úÖ ${hubs.length.toLocaleString()} locations & ${tolls.length} infrastructure markers active.`;
                statusEl.className = "mb-6 p-4 bg-green-50 border border-green-200 rounded-lg text-green-800 font-medium text-sm flex items-center gap-3";
                checkBtn.disabled = false;
                document.getElementById('btnText').innerText = "Analyze SmartRoute";
                
                initMap();
                drawGlobalTolls();
            } catch (err) {
                log(`Sync Error: ${err.message}`, true);
            }
        }

        function log(msg, isError = false) {
            const logBox = document.getElementById('debugLog');
            const lines = document.getElementById('logLines');
            logBox.classList.remove('hidden');
            const entry = document.createElement('div');
            entry.style.color = isError ? '#ff6b6b' : '#4ade80';
            entry.innerText = `> ${msg}`;
            lines.appendChild(entry);
            logBox.scrollTop = logBox.scrollHeight;
        }

        async function geocode(location) {
            if (!location || !location.trim()) return null;
            log(`Searching for: ${location}...`);
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(location)}&countrycodes=us&limit=1`);
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.length > 0) {
                        return { name: location.split(',')[0].trim(), lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon) };
                    }
                }
            } catch (err) {}

            const query = location.toLowerCase();
            const match = hubs.find(h => query.includes(h.name.toLowerCase()) && (!query.includes(',') || query.includes(h.state.toLowerCase())));
            if (match) return match;
            return null;
        }

        function initMap() {
            if (!map) {
                map = L.map('map').setView([39.8283, -98.5795], 4);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(map);
                routeLayer = L.layerGroup().addTo(map);
                markerLayer = L.layerGroup().addTo(map);
            }
        }

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 3963; 
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }

        function interpolatePath(coords, intervalMiles) {
            const densePath = [coords[0]];
            for (let i = 0; i < coords.length - 1; i++) {
                const p1 = coords[i], p2 = coords[i+1];
                const d = getDistance(p1[1], p1[0], p2[1], p2[0]);
                if (d > intervalMiles) {
                    const steps = Math.floor(d / intervalMiles);
                    for (let j = 1; j <= steps; j++) {
                        const f = (j * intervalMiles) / d;
                        densePath.push([p1[0] + f * (p2[0] - p1[0]), p1[1] + f * (p2[1] - p1[1])]);
                    }
                }
                densePath.push(p2);
            }
            return densePath;
        }

        function drawGlobalTolls() {
            if (!markerLayer) return;
            tolls.forEach(t => {
                L.circleMarker([t.lat, t.lon], {
                    radius: 4, fillColor: '#a855f7', color: "#fff", weight: 1, opacity: 0.6, fillOpacity: 0.6
                }).addTo(markerLayer).bindTooltip(`${t.name} ($${t.price.toFixed(2)})`);
            });
        }

        async function calculateAndCheck() {
            const startVal = document.getElementById('startInput').value.trim();
            const s1Val = document.getElementById('stop1Input').value.trim();
            const s2Val = document.getElementById('stop2Input').value.trim();
            const endVal = document.getElementById('endInput').value.trim();

            if (!startVal || !endVal) return;

            const loading = document.getElementById('loading'), resArea = document.getElementById('resultsArea');
            const tollSection = document.getElementById('tollSection'), tollList = document.getElementById('tollList');
            const totalTollEl = document.getElementById('totalTollCost');

            loading.classList.remove('hidden'); resArea.classList.add('hidden');
            tollSection.classList.add('hidden');
            document.getElementById('alertTableBody').innerHTML = '';
            document.getElementById('pathDisplay').innerHTML = '';
            document.getElementById('logLines').innerHTML = '';

            try {
                const startPoint = await geocode(startVal);
                const stop1Point = await geocode(s1Val);
                const stop2Point = await geocode(s2Val);
                const endPoint = await geocode(endVal);

                if (!startPoint || !endPoint) throw new Error("Start or End location not found.");

                const waypoints = [startPoint, stop1Point, stop2Point, endPoint].filter(p => p !== null);
                const wpQuery = waypoints.map(p => `${p.lon},${p.lat}`).join(';');

                log(`Pathing Route across ${waypoints.length} markers...`);
                const osrmUrl = `https://router.project-osrm.org/route/v1/driving/${wpQuery}?overview=full&geometries=geojson`;
                const response = await fetch(osrmUrl);
                const osrmData = await response.json();

                if (!osrmData.routes?.length) throw new Error("Routing logic failed. Check location sequence.");

                const roadCoords = osrmData.routes[0].geometry.coordinates;
                const densePath = interpolatePath(roadCoords, 0.5); // 0.5 mile resolution

                // 1. TOLL LOGIC (4.0mi Radius)
                log(`Scanning for enroute gantries (4mi radius)...`);
                const detectedTolls = [];
                const seenTolls = new Set();
                
                tolls.forEach(toll => {
                    let enroute = false;
                    for (const rp of densePath) {
                        if (getDistance(toll.lat, toll.lon, rp[1], rp[0]) < 4.0) { 
                            enroute = true;
                            break;
                        }
                    }
                    const uniqueId = `${toll.lat.toFixed(5)}-${toll.lon.toFixed(5)}`;
                    if (enroute && !seenTolls.has(uniqueId)) {
                        seenTolls.add(uniqueId);
                        detectedTolls.push(toll);
                    }
                });

                if (detectedTolls.length > 0) {
                    let total = 0;
                    tollList.innerHTML = '';
                    detectedTolls.forEach(t => {
                        total += t.price;
                        const div = document.createElement('div');
                        div.className = 'flex justify-between border-b border-purple-100 py-1 px-1';
                        div.innerHTML = `<span class="truncate pr-2 font-medium">${t.name}</span> <span class="font-bold shrink-0">$${t.price.toFixed(2)}</span>`;
                        tollList.appendChild(div);
                    });
                    totalTollEl.innerText = `Cumulative Toll Total: $${total.toFixed(2)}`;
                    tollSection.classList.remove('hidden');
                }

                // 2. Weather & Origin-Based Scale Logic
                log("Identifying 200-mile weather sequence & local scales...");
                const analysis = findOperationalPoints(densePath, startPoint);
                
                const displaySequence = [startPoint];
                if (stop1Point) displaySequence.push(stop1Point);
                if (stop2Point) displaySequence.push(stop2Point);
                analysis.weatherHubs.forEach(h => displaySequence.push(h));
                displaySequence.push(endPoint);

                const finalUnique = [];
                const seenKeys = new Set();
                displaySequence.forEach(p => {
                    const key = `${p.name.toLowerCase()}`;
                    if (!seenKeys.has(key)) { seenKeys.add(key); finalUnique.push(p); }
                });

                finalUnique.forEach((c, i) => {
                    const span = document.createElement('span');
                    span.className = `bg-blue-100 text-blue-800 px-3 py-1 rounded text-base font-bold border border-blue-200`;
                    span.innerText = c.name;
                    document.getElementById('pathDisplay').appendChild(span);
                    if (i < finalUnique.length - 1) document.getElementById('pathDisplay').innerHTML += `<span class="text-slate-400 mx-1">‚Üí</span>`;
                });
                document.getElementById('routeSummary').classList.remove('hidden');

                initMap();
                drawRoadMap(osrmData.routes[0].geometry, finalUnique, analysis.top3Scales, waypoints);

                // Table Generation
                for (const s of analysis.top3Scales) await processTableRow(s, document.getElementById('alertTableBody'), true);
                for (let i = 0; i < finalUnique.length; i++) {
                    await processTableRow(finalUnique[i], document.getElementById('alertTableBody'), false, true);
                }

                document.getElementById('timestamp').innerText = `SmartRoute Sync: ${new Date().toLocaleTimeString()}`;
                resArea.classList.remove('hidden');
                setTimeout(() => map.invalidateSize(), 200);

            } catch (err) {
                log(`Operational Logic Error: ${err.message}`, true);
            } finally {
                loading.classList.add('hidden');
            }
        }

        function findOperationalPoints(densePath, startPoint) {
            // Weather spacing: target ~200mi gaps as requested
            const weatherHubs = [], seenHubs = new Set();
            let currentTotalDist = 0, lastHubDist = 0;

            for (let i = 1; i < densePath.length; i++) {
                currentTotalDist += getDistance(densePath[i-1][1], densePath[i-1][0], densePath[i][1], densePath[i][0]);
                // UPDATED: Milestone set to 200 miles
                if (currentTotalDist - lastHubDist >= 200) {
                    const rp = densePath[i];
                    let closest = null, minDist = Infinity;
                    hubs.forEach(h => {
                        const d = getDistance(h.lat, h.lon, rp[1], rp[0]);
                        if (d < 35 && d < minDist) { minDist = d; closest = h; }
                    });
                    if (closest) {
                        const key = `${closest.name.toLowerCase()}`;
                        if (!seenHubs.has(key)) { 
                            seenHubs.add(key); 
                            weatherHubs.push(closest); 
                            lastHubDist = currentTotalDist; 
                        }
                    }
                }
            }

            // Origin-Based Scale Logic: 50 Mile Radius from start town
            const localScales = hubs.filter(h => {
                if (!h.isCatScale) return false;
                const d = getDistance(startPoint.lat, startPoint.lon, h.lat, h.lon);
                h.originDist = d;
                return d <= 50;
            });
            localScales.sort((a, b) => a.originDist - b.originDist);
            const top3LocalScales = localScales.slice(0, 3);

            return { weatherHubs, top3Scales: top3LocalScales };
        }

        async function processTableRow(point, tbody, isScaleRow, isEndpoint = false) {
            log(`NWS Sync: ${point.name}...`);
            let reports = false;
            try {
                const response = await fetch(`https://api.weather.gov/alerts/active?point=${parseFloat(point.lat).toFixed(4)},${parseFloat(point.lon).toFixed(4)}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.features?.length > 0) {
                        const filtered = data.features.filter(f => {
                            const e = f.properties.event.toLowerCase();
                            return e.includes('winter') || e.includes('ice') || e.includes('snow') || e.includes('cold') || 
                                   e.includes('wind') || e.includes('storm') || e.includes('flood') || e.includes('warning') || 
                                   e.includes('watch') || e.includes('advisory') || e.includes('special weather') || e.includes('fog');
                        });
                        if (filtered.length > 0) {
                            reports = true;
                            filtered.forEach(alert => appendRow(point, alert, tbody, isScaleRow));
                        }
                    }
                }
            } catch (e) {}
            if (!reports && (isScaleRow || isEndpoint)) appendEmptyRow(point, tbody, isScaleRow);
        }

        function drawRoadMap(geo, routePoints, scales, waypoints) {
            routeLayer.clearLayers(); markerLayer.clearLayers();
            L.geoJSON(geo, { style: { color: '#2563eb', weight: 6, opacity: 0.8 } }).addTo(routeLayer);

            drawGlobalTolls(); 

            const start = waypoints[0];
            const end = waypoints[waypoints.length-1];
            L.circleMarker([start.lat, start.lon], { radius: 10, fillColor: '#10b981', color: "#fff", weight: 2, opacity: 1, fillOpacity: 1 }).addTo(markerLayer).bindTooltip("PICKUP", { permanent: true, direction: 'top' });
            L.circleMarker([end.lat, end.lon], { radius: 10, fillColor: '#ef4444', color: "#fff", weight: 2, opacity: 1, fillOpacity: 1 }).addTo(markerLayer).bindTooltip("DELIVERY", { permanent: true, direction: 'top' });

            for(let i=1; i<waypoints.length-1; i++) {
                const wp = waypoints[i];
                L.circleMarker([wp.lat, wp.lon], { radius: 8, fillColor: '#2563eb', color: "#fff", weight: 2, opacity: 1, fillOpacity: 1 }).addTo(markerLayer).bindTooltip(`STOP ${i}`, { permanent: true, direction: 'top' });
            }

            scales.forEach(s => {
                L.circleMarker([s.lat, s.lon], {
                    radius: 8, fillColor: '#facc15', color: "#fff", weight: 2.5, opacity: 1, fillOpacity: 1
                }).addTo(markerLayer).bindTooltip(`LOCAL SCALE: ${s.name}`, { permanent: false, direction: 'bottom' });
            });

            map.fitBounds(L.latLngBounds(geo.coordinates.map(c => [c[1], c[0]])), { padding: [80, 80], maxZoom: 6 });
        }

        function appendRow(hub, alert, tbody, isScaleRow) {
            const headline = (alert.properties.headline || '').split('...')[0].trim();
            const row = document.createElement('tr');
            row.className = `border-b border-slate-200 transition ${isScaleRow ? 'nearest-cat-row' : 'hover:bg-slate-50'}`;
            row.innerHTML = `
                <td class="p-2 font-black text-blue-900 align-middle text-2xl uppercase">${hub.state || 'US'}</td>
                <td class="p-2 font-bold text-slate-800 align-middle text-xl truncate">${hub.name}${isScaleRow ? '<span class="cat-badge">‚≠ê LOCAL SCALE</span>' : ''}</td>
                <td class="p-2 align-middle w-40 text-center"><span class="px-2 py-0.5 rounded text-[10px] font-black uppercase tracking-tighter block ${getBadgeColor(alert.properties.event)}">${alert.properties.event}</span></td>
                <td class="p-2 text-xl align-middle text-slate-700 font-bold leading-none">
                    <div class="uppercase tracking-tight text-sm"><span class="text-slate-400 mr-2 text-[10px]">Starts</span> ${formatDate(alert.properties.effective)}</div>
                    <div class="uppercase tracking-tight text-sm mt-1"><span class="text-slate-400 mr-2 text-[10px]">Ends</span> ${formatDate(alert.properties.ends || alert.properties.expires)}</div>
                </td>
                <td class="p-2 align-middle">
                    <div class="flex items-center gap-3">
                         <a href="https://forecast.weather.gov/MapClick.php?lat=${hub.lat}&lon=${hub.lon}" target="_blank" class="bg-slate-800 text-white px-3 py-1 rounded text-[10px] uppercase hover:bg-blue-600 shrink-0">View</a>
                         <p class="font-bold text-slate-800 text-lg truncate">${headline}</p>
                    </div>
                </td>
            `;
            tbody.appendChild(row);
        }

        function appendEmptyRow(hub, tbody, isScaleRow) {
            const row = document.createElement('tr');
            row.className = `border-b border-slate-200 transition ${isScaleRow ? 'nearest-cat-row font-black' : 'bg-slate-50 opacity-75'}`;
            row.innerHTML = `
                <td class="p-2 font-black align-middle text-2xl uppercase ${isScaleRow ? 'text-amber-800' : 'text-slate-400'}">${hub.state || 'US'}</td>
                <td class="p-2 font-bold align-middle text-xl ${isScaleRow ? 'text-amber-900' : 'text-slate-400'}">${hub.name}${isScaleRow ? '<span class="cat-badge">‚≠ê LOCAL SCALE</span>' : ''}</td>
                <td class="p-2 align-middle text-center"><span class="px-2 py-0.5 rounded text-[10px] font-black uppercase ${isScaleRow ? 'bg-amber-600 text-white' : 'bg-slate-200 text-slate-500'}">${isScaleRow ? 'Active' : 'None'}</span></td>
                <td class="p-2 text-xl align-middle font-medium italic ${isScaleRow ? 'text-amber-700' : 'text-slate-400'}">${isScaleRow ? 'Origin Weight Check' : 'Clear Conditions'}</td>
                <td class="p-2 align-middle">
                    <div class="flex items-center gap-3">
                         <a href="https://forecast.weather.gov/MapClick.php?lat=${hub.lat}&lon=${hub.lon}" target="_blank" class="px-3 py-1 rounded text-[10px] uppercase transition ${isScaleRow ? 'bg-amber-700 text-white hover:bg-amber-800' : 'bg-slate-300 text-slate-600 hover:bg-slate-400'}">View</a>
                         <p class="${isScaleRow ? 'text-amber-800 font-bold' : 'text-slate-400'} text-lg italic">No active advisories</p>
                    </div>
                </td>
            `;
            tbody.appendChild(row);
        }

        function getBadgeColor(event) {
            const e = event.toLowerCase();
            if (e.includes('warning')) return 'bg-red-600 text-white';
            if (e.includes('watch')) return 'bg-orange-500 text-white';
            return 'bg-blue-600 text-white';
        }

        function formatDate(str) {
            if (!str) return "--";
            const d = new Date(str);
            const hour = d.getHours();
            let p = "Night";
            if (hour >= 5 && hour < 12) p = "Morning";
            else if (hour >= 12 && hour < 17) p = "Noon";
            return `${d.toLocaleDateString([], {month: 'short', day: 'numeric'})} (${p})`;
        }
    </script>
</body>
</html>
