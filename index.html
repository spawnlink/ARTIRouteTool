<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartRoute - Logistics & Weather Engine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Leaflet Map CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <!-- Leaflet Map JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <style>
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 2s linear infinite;
            display: inline-block;
            vertical-align: middle;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        table { table-layout: fixed; width: 100%; border-collapse: collapse; }
        th, td { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        
        #map {
            height: 550px;
            width: 100%;
            border-radius: 0.75rem;
            border: 1px solid #e2e8f0;
            z-index: 10;
        }

        .cat-badge {
            background-color: #f59e0b;
            color: white;
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 900;
            text-transform: uppercase;
            margin-left: 6px;
            display: inline-block;
            vertical-align: middle;
            box-shadow: 0 1px 2px rgba(0,0,0,0.15);
            border: 1px solid #d97706;
        }

        .wash-badge {
            background-color: #2563eb;
            color: white;
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 900;
            text-transform: uppercase;
            margin-left: 6px;
            display: inline-block;
            vertical-align: middle;
            box-shadow: 0 1px 2px rgba(0,0,0,0.15);
            border: 1px solid #1e3a8a;
        }

        .section-card {
            background: white;
            border-radius: 0.75rem;
            border: 1px solid #e2e8f0;
            margin-bottom: 1.5rem;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.7rem;
            font-weight: 800;
            color: #475569;
            margin-top: 0.5rem;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .nearest-cat-row { background-color: #fffbeb !important; border-left: 10px solid #f59e0b !important; }
        .wash-row { background-color: #eff6ff !important; border-left: 10px solid #2563eb !important; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen p-4 md:p-8 font-sans text-slate-900">

    <div class="max-w-full mx-auto bg-white rounded-xl shadow-lg overflow-hidden border border-slate-200">
        <div class="bg-blue-900 p-6 text-white">
            <h1 class="text-3xl font-bold flex items-center gap-2">
                üöÄ SmartRoute
            </h1>
            <p class="text-blue-100 text-base mt-1">
                Multi-Stop Dispatch Engine: Webhook Sync, 0.5mi Resampling, 50mi Wash Radius, 4mi Toll Net.
            </p>
        </div>

        <div class="p-6">
            <div id="dataLoadingStatus" class="mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg text-yellow-800 font-medium text-sm flex items-center gap-3">
                <div class="loader !w-4 !h-4 !border-2"></div>
                Syncing global logistics, toll, and brand-aware wash databases...
            </div>

            <!-- Route Inputs -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="p-3 bg-slate-50 rounded-lg border border-slate-200">
                    <label class="block text-xs font-black text-slate-500 uppercase tracking-widest mb-1">Pickup (Start)</label>
                    <input type="text" id="startInput" placeholder="City, State" class="w-full border p-2 rounded-md focus:ring-2 focus:ring-blue-500 outline-none text-sm font-bold">
                    <label class="checkbox-label">
                        <input type="checkbox" id="startWash" tabindex="-1"> Add Truck Wash
                    </label>
                </div>
                <div class="p-3 bg-slate-50 rounded-lg border border-slate-200">
                    <label class="block text-xs font-black text-slate-500 uppercase tracking-widest mb-1">Stop 1</label>
                    <input type="text" id="stop1Input" placeholder="City, State" class="w-full border p-2 rounded-md focus:ring-2 focus:ring-blue-500 outline-none text-sm font-bold">
                    <label class="checkbox-label">
                        <input type="checkbox" id="stop1Wash" tabindex="-1"> Add Truck Wash
                    </label>
                </div>
                <div class="p-3 bg-slate-50 rounded-lg border border-slate-200">
                    <label class="block text-xs font-black text-slate-500 uppercase tracking-widest mb-1">Stop 2</label>
                    <input type="text" id="stop2Input" placeholder="City, State" class="w-full border p-2 rounded-md focus:ring-2 focus:ring-blue-500 outline-none text-sm font-bold">
                    <label class="checkbox-label">
                        <input type="checkbox" id="stop2Wash" tabindex="-1"> Add Truck Wash
                    </label>
                </div>
                <div class="p-3 bg-slate-50 rounded-lg border border-slate-200">
                    <label class="block text-xs font-black text-slate-500 uppercase tracking-widest mb-1">Delivery (End)</label>
                    <input type="text" id="endInput" placeholder="City, State" class="w-full border p-2 rounded-md focus:ring-2 focus:ring-blue-500 outline-none text-sm font-bold">
                    <label class="checkbox-label">
                        <input type="checkbox" id="endWash" tabindex="-1"> Add Truck Wash
                    </label>
                </div>
            </div>

            <button onclick="calculateAndCheck()" id="checkBtn" disabled class="w-full bg-blue-700 hover:bg-blue-800 disabled:bg-slate-300 disabled:cursor-not-allowed text-white font-bold py-5 px-6 rounded-xl shadow-lg transition flex items-center justify-center gap-2 text-2xl tracking-tight">
                <span id="btnText">Initializing Data...</span>
            </button>

            <!-- Debug Window -->
            <div id="debugLog" class="mt-4 p-3 bg-black text-green-400 text-xs font-mono rounded-lg h-24 overflow-y-auto hidden">
                <div id="logLines"></div>
            </div>

            <div id="loading" class="hidden mt-6 p-6 bg-blue-50 text-blue-700 rounded-xl text-center border border-blue-100">
                <div class="loader mr-3"></div> 
                <span id="loadingText" class="font-bold text-xl">Mapping chain and polling enroute databases...</span>
            </div>

            <div id="routeSummary" class="hidden mt-6 mb-4 p-4 bg-slate-50 border rounded-lg flex flex-wrap gap-2 items-center text-lg text-slate-600">
                <span class="font-bold text-slate-800">Operational Chain:</span>
                <div id="pathDisplay" class="flex flex-wrap gap-1 items-center"></div>
            </div>

            <!-- Toll Summary Section -->
            <div id="tollSection" class="hidden mb-6 bg-purple-50 border border-purple-200 rounded-lg p-4 shadow-sm">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-lg font-bold text-purple-900 flex items-center gap-2">
                        <span class="text-xl">üí∞</span> Cumulative Toll Gantry Costs (5-Axle)
                    </h3>
                    <span id="totalTollCost" class="bg-purple-600 text-white px-4 py-1.5 rounded-full text-lg font-bold"></span>
                </div>
                <div id="tollList" class="text-xs text-purple-800 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-x-4 gap-y-1 max-h-48 overflow-y-auto mt-2">
                </div>
            </div>

            <div id="resultsArea" class="hidden">
                
                <!-- ORIGIN SCALE SECTION -->
                <div id="scaleSection" class="hidden section-card mb-6 border-amber-200 bg-amber-50">
                    <div class="bg-amber-600 text-white px-4 py-2 font-black uppercase text-xs tracking-widest flex items-center gap-2">
                        ‚≠ê Top 3 Origin CAT Scales (50mi Radius)
                    </div>
                    <div class="p-0">
                        <table class="w-full text-left">
                            <tbody id="scaleTableBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- TRUCK WASH SECTION -->
                <div id="washSection" class="hidden section-card mb-6 border-blue-200 bg-blue-50">
                    <div class="bg-blue-600 text-white px-4 py-2 font-black uppercase text-xs tracking-widest flex items-center gap-2">
                        üíß Nearby Truck Washes (50mi Radius of Checked Stops)
                    </div>
                    <div class="p-0">
                        <table class="w-full text-left">
                            <tbody id="washTableBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- MAIN TRIP REPORT -->
                <div class="section-card">
                    <div class="bg-slate-800 text-white px-4 py-2 font-black uppercase text-xs tracking-widest flex justify-between items-center">
                        <span class="flex items-center gap-2">üó∫Ô∏è Operational Trip Report (200mi Weather Milestones)</span>
                        <span id="timestamp" class="text-[10px] italic opacity-70"></span>
                    </div>
                    <div class="p-0">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="bg-slate-100 border-b border-slate-200">
                                    <th class="p-2 text-xs font-black uppercase text-slate-500 w-28">State</th>
                                    <th class="p-2 text-xs font-black uppercase text-slate-500 w-48">Location</th>
                                    <th class="p-2 text-xs font-black uppercase text-slate-500 w-32 text-center">Event</th>
                                    <th class="p-2 text-xs font-black uppercase text-slate-500 w-64">Timing</th>
                                    <th class="p-2 text-xs font-black uppercase text-slate-500">Hazard Details</th>
                                </tr>
                            </thead>
                            <tbody id="alertTableBody"></tbody>
                        </table>
                    </div>
                </div>
                
                <div id="mapSection" class="mt-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Infrastructure Visualization</h3>
                    <div id="map" class="shadow-inner"></div>
                    <div class="flex justify-center gap-4 mt-3 text-xs flex-wrap">
                        <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-[#10b981]"></span> Pickup</div>
                        <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-[#ef4444]"></span> Delivery</div>
                        <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-[#2563eb]"></span> Intermediate Stop</div>
                        <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-[#3b82f6]"></span> Weather Hub</div>
                        <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-[#facc15] shadow-[0_0_5px_#facc15]"></span> CAT Scale</div>
                        <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-blue-600 border border-white"></span> Truck Wash</div>
                        <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-[#a855f7]"></span> Toll Gantry</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let map = null, routeLayer = null, markerLayer = null;
        let hubs = [], tolls = [], washes = [];

        const cityCsvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQCgGN8rGTUO3hN-b2QKMe3cLchE_45Y-xfsFciJc-YJ_NJ-Z3_TZSMzRV2Jthc-FYGpnQoycZmvVpv/pub?gid=0&single=true&output=csv";
        const tollCsvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQCgGN8rGTUO3hN-b2QKMe3cLchE_45Y-xfsFciJc-YJ_NJ-Z3_TZSMzRV2Jthc-FYGpnQoycZmvVpv/pub?gid=1793109645&single=true&output=csv";
        const washCsvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQCgGN8rGTUO3hN-b2QKMe3cLchE_45Y-xfsFciJc-YJ_NJ-Z3_TZSMzRV2Jthc-FYGpnQoycZmvVpv/pub?gid=819928679&single=true&output=csv";
        const webhookUrl = "https://chat.googleapis.com/v1/spaces/AAAAATN6AAc/messages?key=AIzaSyDdI0hCZtE6vySjMm-WEfRq3CPzqKqqsHI&token=PaDfLcEmmGRAZBoq5bm9_m2rCCe1eU3YS1hKMCVfWJc";

        window.onload = async () => {
            await loadAllData();
            ['startInput', 'stop1Input', 'stop2Input', 'endInput'].forEach(id => {
                document.getElementById(id).addEventListener("keypress", (e) => {
                    if (e.key === "Enter") {
                        e.preventDefault();
                        if (!document.getElementById('checkBtn').disabled) calculateAndCheck();
                    }
                });
            });
        };

        function parseCSVLine(line) {
            const result = []; let cell = '', inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') inQuotes = !inQuotes;
                else if (char === ',' && !inQuotes) { result.push(cell); cell = ''; }
                else cell += char;
            }
            result.push(cell); return result;
        }

        async function loadAllData() {
            const statusEl = document.getElementById('dataLoadingStatus'), checkBtn = document.getElementById('checkBtn');
            try {
                const cityRes = await fetch(cityCsvUrl);
                const cityText = await cityRes.text();
                const cityLines = cityText.split(/\r?\n/).filter(l => l.trim().length > 0);
                hubs = cityLines.slice(1).map(line => {
                    const parts = parseCSVLine(line);
                    if (parts.length < 4) return null;
                    return { name: parts[0].trim(), state: parts[1].trim(), lat: parseFloat(parts[2]), lon: parseFloat(parts[3]), pop: parseInt(parts[4]) || 0, isCatScale: parts[5] ? (parts[5].toLowerCase().includes('true') || parts[5].trim() === '1') : false };
                }).filter(h => h !== null && !isNaN(h.lat));

                const tollRes = await fetch(tollCsvUrl);
                const tollText = await tollRes.text();
                if (tollText) {
                    const tollLines = tollText.split(/\r?\n/).filter(l => l.trim().length > 0);
                    const headers = parseCSVLine(tollLines[0]).map(h => h.trim().toLowerCase());
                    const latIdx = headers.findIndex(h => h.includes('lat')), lonIdx = headers.findIndex(h => h.includes('lon') || h.includes('lng') || h.includes('long')), nameIdx = headers.indexOf('name') !== -1 ? headers.indexOf('name') : (headers.indexOf('city') !== -1 ? headers.indexOf('city') : 0), rateIdx = headers.findIndex(h => h.includes('rate') || h.includes('price') || h.includes('cost') || h.includes('axle'));
                    tolls = tollLines.slice(1).map(line => {
                        const parts = parseCSVLine(line);
                        const lat = parseFloat(parts[latIdx]), lon = parseFloat(parts[lonIdx]);
                        if (isNaN(lat) || isNaN(lon)) return null;
                        const price = parseFloat((parts[rateIdx] || "0").replace(/[^0-9.]/g, '')) || 0;
                        return { name: parts[nameIdx]?.trim() || "Toll", lat, lon, price };
                    }).filter(t => t !== null);
                }

                const washRes = await fetch(washCsvUrl);
                const washText = await washRes.text();
                if (washText) {
                    const washLines = washText.split(/\r?\n/).filter(l => l.trim().length > 0);
                    const headers = parseCSVLine(washLines[0]).map(h => h.trim().toLowerCase());
                    const wLatIdx = headers.findIndex(h => h.includes('lat')), wLonIdx = headers.findIndex(h => h.includes('lon') || h.includes('lng') || h.includes('long')), wCityIdx = headers.findIndex(h => h === 'city'), wBrandIdx = headers.findIndex(h => h.includes('brand') || h.includes('brabd'));
                    washes = washLines.slice(1).map(line => {
                        const parts = parseCSVLine(line);
                        const lat = parseFloat(parts[wLatIdx]), lon = parseFloat(parts[wLonIdx]);
                        if (isNaN(lat) || isNaN(lon)) return null;
                        return { name: parts[wCityIdx]?.trim() || "Wash Location", brand: parts[wBrandIdx]?.trim() || "Independent", lat, lon };
                    }).filter(w => w !== null);
                }

                statusEl.innerHTML = `‚úÖ ${hubs.length.toLocaleString()} locations, ${tolls.length} tolls & ${washes.length} washes active. Ready.`;
                statusEl.className = "mb-6 p-4 bg-green-50 border border-green-200 rounded-lg text-green-800 font-medium text-sm flex items-center gap-3";
                checkBtn.disabled = false; document.getElementById('btnText').innerText = "Analyze SmartRoute";
                initMap(); drawGlobalTolls();
            } catch (err) { log(`Sync Error: ${err.message}`, true); }
        }

        function log(msg, isError = false) {
            const logBox = document.getElementById('debugLog'), lines = document.getElementById('logLines');
            logBox.classList.remove('hidden');
            const entry = document.createElement('div'); entry.style.color = isError ? '#ff6b6b' : '#4ade80'; entry.innerText = `> ${msg}`;
            lines.appendChild(entry); logBox.scrollTop = logBox.scrollHeight;
        }

        async function notifyWebhook(waypoints) {
            log(`Syncing Dispatch to Google Chat...`);
            const stopsText = waypoints.map((wp, i) => {
                const label = i === 0 ? "Pickup" : (i === waypoints.length - 1 ? "Delivery" : `Stop ${i}`);
                return `${label}: ${wp.name}, ${wp.state || ''}`;
            }).join(' ‚Üí ');

            const payload = {
                text: `üöõ *SmartRoute Dispatch Initiated*\n*Sequence:* ${stopsText}\n*Time:* ${new Date().toLocaleString()}`
            };

            try {
                await fetch(webhookUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
            } catch (err) {
                console.error("Webhook notification failed:", err);
            }
        }

        async function geocode(location) {
            if (!location || !location.trim()) return null;
            log(`Locating: ${location}...`);
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(location)}&countrycodes=us&limit=1`);
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.length > 0) return { name: location.split(',')[0].trim(), lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon) };
                }
            } catch (err) {}
            const query = location.toLowerCase();
            return hubs.find(h => query.includes(h.name.toLowerCase()) && (!query.includes(',') || query.includes(h.state.toLowerCase()))) || null;
        }

        function initMap() {
            if (!map) {
                map = L.map('map').setView([39.8283, -98.5795], 4);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(map);
                routeLayer = L.layerGroup().addTo(map); markerLayer = L.layerGroup().addTo(map);
            }
        }

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 3963; 
            const dLat = (lat2 - lat1) * Math.PI / 180, dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }

        function interpolatePath(coords, intervalMiles) {
            const densePath = [coords[0]];
            for (let i = 0; i < coords.length - 1; i++) {
                const p1 = coords[i], p2 = coords[i+1], d = getDistance(p1[1], p1[0], p2[1], p2[0]);
                if (d > intervalMiles) {
                    const steps = Math.floor(d / intervalMiles);
                    for (let j = 1; j <= steps; j++) {
                        const f = (j * intervalMiles) / d;
                        densePath.push([p1[0] + f * (p2[0] - p1[0]), p1[1] + f * (p2[1] - p1[1])]);
                    }
                }
                densePath.push(p2);
            }
            return densePath;
        }

        function drawGlobalTolls() {
            if (!markerLayer) return;
            tolls.forEach(t => { L.circleMarker([t.lat, t.lon], { radius: 4, fillColor: '#a855f7', color: "#fff", weight: 1, opacity: 0.6, fillOpacity: 0.6 }).addTo(markerLayer).bindTooltip(`${t.name} ($${t.price.toFixed(2)})`); });
        }

        async function calculateAndCheck() {
            const inputs = [
                { id: 'startInput', washId: 'startWash', label: 'Pickup' },
                { id: 'stop1Input', washId: 'stop1Wash', label: 'Stop 1' },
                { id: 'stop2Input', washId: 'stop2Wash', label: 'Stop 2' },
                { id: 'endInput', washId: 'endWash', label: 'Delivery' }
            ];

            const loading = document.getElementById('loading'), resArea = document.getElementById('resultsArea');
            const tollSection = document.getElementById('tollSection'), tollList = document.getElementById('tollList'), totalTollEl = document.getElementById('totalTollCost');
            const scaleSection = document.getElementById('scaleSection'), washSection = document.getElementById('washSection');
            
            loading.classList.remove('hidden'); resArea.classList.add('hidden'); 
            tollSection.classList.add('hidden'); scaleSection.classList.add('hidden'); washSection.classList.add('hidden');
            
            document.getElementById('scaleTableBody').innerHTML = '';
            document.getElementById('washTableBody').innerHTML = '';
            document.getElementById('alertTableBody').innerHTML = '';
            document.getElementById('pathDisplay').innerHTML = '';
            document.getElementById('logLines').innerHTML = '';

            try {
                const waypoints = [];
                for (const inp of inputs) {
                    const val = document.getElementById(inp.id).value.trim();
                    if (val) {
                        const pt = await geocode(val);
                        if (pt) { pt.label = inp.label; pt.requestWash = document.getElementById(inp.washId).checked; waypoints.push(pt); }
                    }
                }
                if (waypoints.length < 2) throw new Error("Pickup and Delivery required.");

                // Trigger Webhook Sync
                notifyWebhook(waypoints);

                const wpQuery = waypoints.map(p => `${p.lon},${p.lat}`).join(';');
                const response = await fetch(`https://router.project-osrm.org/route/v1/driving/${wpQuery}?overview=full&geometries=geojson`);
                const osrmData = await response.json();
                const roadCoords = osrmData.routes[0].geometry.coordinates;
                const densePath = interpolatePath(roadCoords, 0.5);

                // 1. TOLLS (4mi radius)
                const detectedTolls = [], seenTolls = new Set();
                tolls.forEach(toll => {
                    let enroute = false;
                    for (const rp of densePath) { if (getDistance(toll.lat, toll.lon, rp[1], rp[0]) < 4.0) { enroute = true; break; } }
                    const uid = `${toll.lat.toFixed(5)}-${toll.lon.toFixed(5)}`;
                    if (enroute && !seenTolls.has(uid)) { seenTolls.add(uid); detectedTolls.push(toll); }
                });
                if (detectedTolls.length > 0) {
                    let total = 0; tollList.innerHTML = '';
                    detectedTolls.forEach(t => {
                        total += t.price;
                        const div = document.createElement('div'); div.className = 'flex justify-between border-b border-purple-100 py-1 px-1';
                        div.innerHTML = `<span class="truncate pr-2 font-medium">${t.name}</span> <span class="font-bold shrink-0">$${t.price.toFixed(2)}</span>`;
                        tollList.appendChild(div);
                    });
                    totalTollEl.innerText = `Total: $${total.toFixed(2)}`; tollSection.classList.remove('hidden');
                }

                // 2. LOGISTICS DATA
                const top3OriginScales = hubs.filter(h => h.isCatScale)
                    .map(h => ({...h, dist: getDistance(waypoints[0].lat, waypoints[0].lon, h.lat, h.lon)}))
                    .filter(h => h.dist <= 50).sort((a,b) => a.dist - b.dist).slice(0, 3);

                const requestedWashes = [];
                waypoints.forEach(wp => {
                    if (wp.requestWash) {
                        washes.filter(w => getDistance(wp.lat, wp.lon, w.lat, w.lon) <= 50)
                            .map(w => ({...w, nearStop: wp.name, dist: getDistance(wp.lat, wp.lon, w.lat, w.lon)}))
                            .sort((a,b) => a.dist - b.dist).slice(0, 3).forEach(lw => requestedWashes.push(lw));
                    }
                });

                const weatherHubs = [], seenHubs = new Set();
                let currentTotalDist = 0, lastHubDist = 0;
                for (let i = 1; i < densePath.length; i++) {
                    currentTotalDist += getDistance(densePath[i-1][1], densePath[i-1][0], densePath[i][1], densePath[i][0]);
                    if (currentTotalDist - lastHubDist >= 200) {
                        const rp = densePath[i]; let closest = null, minDist = Infinity;
                        hubs.forEach(h => { const d = getDistance(h.lat, h.lon, rp[1], rp[0]); if (d < 35 && d < minDist) { minDist = d; closest = h; } });
                        if (closest && !seenHubs.has(closest.name.toLowerCase())) { seenHubs.add(closest.name.toLowerCase()); weatherHubs.push(closest); lastHubDist = currentTotalDist; }
                    }
                }

                const enrouteScales = [];
                const seenEIds = new Set();
                hubs.forEach(h => {
                    if(h.isCatScale) {
                        let isE = false;
                        for (const rp of densePath) { if (getDistance(h.lat, h.lon, rp[1], rp[0]) < 1.0) { isE = true; break; } }
                        if(isE && !seenEIds.has(h.name)) { seenEIds.add(h.name); enrouteScales.push(h); }
                    }
                });

                const tripSequence = [...waypoints, ...enrouteScales, ...weatherHubs].sort((a,b) => getDistance(waypoints[0].lat, waypoints[0].lon, a.lat, a.lon) - getDistance(waypoints[0].lat, waypoints[0].lon, b.lat, b.lon));

                tripSequence.forEach((c, i) => {
                    const span = document.createElement('span'); span.className = `bg-blue-100 text-blue-800 px-3 py-1 rounded text-xs font-bold border border-blue-200`;
                    span.innerText = c.name; document.getElementById('pathDisplay').appendChild(span);
                    if (i < tripSequence.length - 1) document.getElementById('pathDisplay').innerHTML += `<span class="text-slate-400 mx-1">‚Üí</span>`;
                });
                document.getElementById('routeSummary').classList.remove('hidden');

                if (top3OriginScales.length > 0) {
                    scaleSection.classList.remove('hidden');
                    for (const s of top3OriginScales) appendSimpleOperationalRow(s, document.getElementById('scaleTableBody'), 'scale');
                }
                if (requestedWashes.length > 0) {
                    washSection.classList.remove('hidden');
                    for (const w of requestedWashes) appendSimpleOperationalRow(w, document.getElementById('washTableBody'), 'wash');
                }
                for (const p of tripSequence) await processTableRow(p, document.getElementById('alertTableBody'), false);

                initMap(); drawRoadMap(osrmData.routes[0].geometry, waypoints, top3OriginScales, requestedWashes);
                document.getElementById('timestamp').innerText = `Synced: ${new Date().toLocaleTimeString()}`;
                resArea.classList.remove('hidden'); setTimeout(() => map.invalidateSize(), 200);

            } catch (err) { log(`Operational Error: ${err.message}`, true); } finally { loading.classList.add('hidden'); }
        }

        function appendSimpleOperationalRow(point, tbody, type) {
            const row = document.createElement('tr');
            let badge = '';
            if(type === 'scale') badge = '<span class="cat-badge">‚≠ê ORIGIN SCALE</span>';
            else if(type === 'wash') badge = `<span class="wash-badge">${point.brand || 'WASH'} NEAR ${point.nearStop || 'STOP'}</span>`;

            row.className = `border-b border-slate-100 ${type==='scale'?'nearest-cat-row':(type==='wash'?'wash-row':'')}`;
            row.innerHTML = `
                <td class="p-2 font-black text-blue-900 text-lg uppercase">${point.state || 'US'}</td>
                <td class="p-2 font-bold text-slate-800 text-lg" colspan="2">${point.name}${badge}</td>
                <td class="p-2 text-xl align-middle font-medium italic text-slate-400" colspan="2">${type === 'scale' ? 'Origin Weight Check' : (type === 'wash' ? `Facility Proximity Search` : '')}</td>
            `;
            tbody.appendChild(row);
        }

        async function processTableRow(point, tbody, type) {
            log(`Syncing report for ${point.name}...`);
            let reports = false;
            try {
                const response = await fetch(`https://api.weather.gov/alerts/active?point=${parseFloat(point.lat).toFixed(4)},${parseFloat(point.lon).toFixed(4)}`);
                if (response.ok) {
                    const data = await response.json();
                    const filtered = (data.features || []).filter(f => {
                        const e = f.properties.event.toLowerCase();
                        return e.includes('winter') || e.includes('ice') || e.includes('snow') || e.includes('cold') || e.includes('wind') || e.includes('storm') || e.includes('flood') || e.includes('warning') || e.includes('watch') || e.includes('advisory') || e.includes('fog');
                    });
                    if (filtered.length > 0) { reports = true; filtered.forEach(alert => appendWeatherRow(point, alert, tbody, type)); }
                }
            } catch (e) {}
            if (!reports) appendEmptyWeatherRow(point, tbody, type);
        }

        function drawRoadMap(geo, waypoints, originScales, requestedWashes) {
            routeLayer.clearLayers(); markerLayer.clearLayers();
            L.geoJSON(geo, { style: { color: '#2563eb', weight: 6, opacity: 0.8 } }).addTo(routeLayer);
            drawGlobalTolls(); 
            waypoints.forEach((wp, i) => {
                const color = i === 0 ? '#10b981' : (i === waypoints.length-1 ? '#ef4444' : '#2563eb');
                L.circleMarker([wp.lat, wp.lon], { radius: 10, fillColor: color, color: "#fff", weight: 2, opacity: 1, fillOpacity: 1 }).addTo(markerLayer).bindTooltip(wp.label || wp.name, { permanent: true, direction: 'top' });
            });
            originScales.forEach(s => L.circleMarker([s.lat, s.lon], { radius: 8, fillColor: '#facc15', color: "#fff", weight: 2.5, opacity: 1, fillOpacity: 1 }).addTo(markerLayer).bindTooltip(`SCALE: ${s.name}`, { direction: 'bottom' }));
            requestedWashes.forEach(w => L.circleMarker([w.lat, w.lon], { radius: 7, fillColor: '#2563eb', color: "#fff", weight: 2, opacity: 1, fillOpacity: 1 }).addTo(markerLayer).bindTooltip(`WASH: ${w.brand || ''} ${w.name}`, { direction: 'bottom' }));
            
            const allCoords = geo.coordinates.map(c => [c[1], c[0]]);
            map.fitBounds(L.latLngBounds(allCoords), { padding: [150, 150], maxZoom: 5 });
        }

        function appendWeatherRow(point, alert, tbody, type) {
            const headline = (alert.properties.headline || '').split('...')[0].trim();
            const row = document.createElement('tr');
            let badge = '';
            if(type === 'scale') badge = '<span class="cat-badge">‚≠ê ENROUTE SCALE</span>';
            else if(type === 'wash') badge = `<span class="wash-badge">${point.brand || 'WASH'} NEAR ${point.nearStop || 'STOP'}</span>`;

            row.className = `border-b border-slate-100 ${type==='scale'?'nearest-cat-row':(type==='wash'?'wash-row':'')}`;
            row.innerHTML = `
                <td class="p-2 font-black text-blue-900 text-lg uppercase">${point.state || 'US'}</td>
                <td class="p-2 font-bold text-slate-800 text-lg">${point.name}${badge}</td>
                <td class="p-2 align-middle text-center"><span class="px-2 py-0.5 rounded text-[10px] font-black uppercase block ${getBadgeColor(alert.properties.event)}">${alert.properties.event}</span></td>
                <td class="p-2 text-xs font-bold leading-none">
                    <div class="uppercase text-slate-400 mb-1">Starts: ${formatDate(alert.properties.effective)}</div>
                    <div class="uppercase text-slate-400">Ends: ${formatDate(alert.properties.ends || alert.properties.expires)}</div>
                </td>
                <td class="p-2 align-middle">
                    <div class="flex items-center gap-3"><a href="https://forecast.weather.gov/MapClick.php?lat=${point.lat}&lon=${point.lon}" target="_blank" class="bg-slate-700 text-white px-2 py-1 rounded text-[10px] uppercase font-black shrink-0">View Link</a><p class="font-bold text-slate-800 text-sm truncate">${headline}</p></div>
                </td>
            `;
            tbody.appendChild(row);
        }

        function appendEmptyWeatherRow(point, tbody, type) {
            const row = document.createElement('tr');
            let badge = '';
            if(type === 'scale') badge = '<span class="cat-badge">‚≠ê SCALE</span>';
            else if(type === 'wash') badge = `<span class="wash-badge">${point.brand || 'WASH'} NEAR ${point.nearStop || 'STOP'}</span>`;

            row.className = `border-b border-slate-100 ${type==='scale'?'nearest-cat-row':(type==='wash'?'wash-row':'bg-slate-50 opacity-70')}`;
            row.innerHTML = `
                <td class="p-2 font-black text-slate-400 text-lg uppercase">${point.state || 'US'}</td>
                <td class="p-2 font-bold text-slate-500 text-lg">${point.name}${badge}</td>
                <td class="p-2 align-middle text-center"><span class="px-2 py-0.5 rounded text-[10px] font-black uppercase bg-slate-200 text-slate-500">${type ? 'Active' : 'None'}</span></td>
                <td class="p-2 text-xl align-middle font-medium italic text-slate-400 tracking-tight">${type === 'scale' ? 'Enroute Weight Check' : (type === 'wash' ? `Near ${point.nearStop}` : 'Clear Conditions')}</td>
                <td class="p-2 align-middle">
                    <div class="flex items-center gap-3"><a href="https://forecast.weather.gov/MapClick.php?lat=${point.lat}&lon=${point.lon}" target="_blank" class="bg-slate-300 text-slate-500 px-2 py-1 rounded text-[10px] uppercase font-black shrink-0">View Link</a><p class="text-slate-400 text-sm italic">Clear segment</p></div>
                </td>
            `;
            tbody.appendChild(row);
        }

        function getBadgeColor(event) {
            const e = event.toLowerCase();
            if (e.includes('warning')) return 'bg-red-600 text-white';
            if (e.includes('watch')) return 'bg-orange-500 text-white';
            return 'bg-blue-600 text-white';
        }

        function formatDate(str) {
            if (!str) return "--";
            const d = new Date(str), hour = d.getHours();
            let p = hour >= 5 && hour < 12 ? "AM" : (hour >= 12 && hour < 17) ? "PM" : "Night";
            return `${d.toLocaleDateString([], {month: 'short', day: 'numeric'})} (${p})`;
        }
    </script>
</body>
</html>
