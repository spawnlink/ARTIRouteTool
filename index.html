<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trucking Weather Route Alert Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Leaflet Map CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <!-- Leaflet Map JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <style>
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 2s linear infinite;
            display: inline-block;
            vertical-align: middle;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Ensure table layout is fixed to respect truncation */
        table { table-layout: fixed; width: 100%; border-collapse: collapse; }
        th, td { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        
        #map {
            height: 450px;
            width: 100%;
            border-radius: 0.75rem;
            border: 1px solid #e2e8f0;
            z-index: 10;
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen p-4 md:p-8 font-sans">

    <!-- Full-width Container -->
    <div class="max-w-full mx-auto bg-white rounded-xl shadow-lg overflow-hidden border border-slate-200">
        <div class="bg-blue-900 p-6 text-white">
            <h1 class="text-3xl font-bold flex items-center gap-2">
                ðŸš€ Smart-Route Weather System
            </h1>
            <p class="text-blue-100 text-base mt-1 text-balance">Direct path analysis for trucking corridors. Fetches sequenced NWS alerts in order of travel.</p>
        </div>

        <div class="p-6">
            <div id="dataLoadingStatus" class="mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg text-yellow-800 font-medium text-sm flex items-center gap-3">
                <div class="loader !w-4 !h-4 !border-2"></div>
                Initializing high-density city database from cloud source...
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1 text-lg">Start City (e.g., Kalona, IA)</label>
                    <input type="text" id="startInput" placeholder="City, State" class="w-full border p-4 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none shadow-sm text-xl">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1 text-lg">End City (e.g., Dallas, TX)</label>
                    <input type="text" id="endInput" placeholder="City, State" class="w-full border p-4 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none shadow-sm text-xl">
                </div>
            </div>

            <button onclick="calculateAndCheck()" id="checkBtn" disabled class="w-full bg-blue-700 hover:bg-blue-800 disabled:bg-slate-300 disabled:cursor-not-allowed text-white font-bold py-5 px-6 rounded-xl shadow-lg transition flex items-center justify-center gap-2 text-2xl">
                <span id="btnText">Loading Database...</span>
            </button>

            <!-- Status Console -->
            <div id="debugLog" class="mt-4 p-3 bg-black text-green-400 text-xs font-mono rounded-lg h-24 overflow-y-auto hidden">
                <div class="mb-1 text-white border-b border-gray-700 pb-1 font-bold">Trip Analysis Progress:</div>
                <div id="logLines"></div>
            </div>

            <div id="loading" class="hidden mt-6 p-6 bg-blue-50 text-blue-700 rounded-xl text-center border border-blue-100">
                <div class="loader mr-3"></div> 
                <span id="loadingText" class="font-bold text-xl">Mapping corridor and fetching live weather data...</span>
            </div>

            <div id="routeSummary" class="hidden mt-6 mb-4 p-4 bg-slate-50 border rounded-lg flex flex-wrap gap-2 items-center text-lg text-slate-600">
                <span class="font-bold text-slate-800">Planned Corridor:</span>
                <div id="pathDisplay" class="flex flex-wrap gap-1 items-center"></div>
            </div>

            <div id="resultsArea" class="hidden">
                <div class="mb-4 flex justify-between items-center border-b pb-1">
                    <h2 class="text-2xl font-bold text-gray-800">Sequenced Trip Alerts</h2>
                    <span id="timestamp" class="text-sm text-gray-500 italic"></span>
                </div>

                <div class="overflow-x-auto mb-8">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="bg-slate-100 border-b-2 border-slate-200">
                                <th class="p-2 text-xs font-black uppercase tracking-widest text-slate-500 w-28 text-lg">State</th>
                                <th class="p-2 text-xs font-black uppercase tracking-widest text-slate-500 w-48 text-lg">City</th>
                                <th class="p-2 text-xs font-black uppercase tracking-widest text-slate-500 w-40 text-lg text-center">Type</th>
                                <th class="p-2 text-xs font-black uppercase tracking-widest text-slate-500 w-64 text-lg">Timing</th>
                                <th class="p-2 text-xs font-black uppercase tracking-widest text-slate-500 text-lg">Hazard Details</th>
                            </tr>
                        </thead>
                        <tbody id="alertTableBody">
                            <!-- Results inject here -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Map Visualization -->
                <div id="mapSection" class="mt-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Trip Visualizer</h3>
                    <div id="map" class="shadow-inner"></div>
                    <p class="text-xs text-slate-400 italic mt-2 text-center">Interactive map showing selected corridor hubs from Start to Finish.</p>
                </div>

                <div id="noAlerts" class="hidden p-16 text-center text-gray-500 italic bg-slate-50 rounded-xl mt-4 border-2 border-dashed">
                    No severe winter alerts found for this specific corridor at this time.
                </div>
            </div>
        </div>

        <div class="bg-slate-50 p-4 text-[10px] text-gray-400 text-center uppercase tracking-widest">
            Direct Path Vector Mapping â€¢ Official NWS Data Stream
        </div>
    </div>

    <script>
        let map = null;
        let routeLayer = null;
        let markerLayer = null;
        let hubs = []; // Dynamically populated from Google Sheets

        const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQCgGN8rGTUO3hN-b2QKMe3cLchE_45Y-xfsFciJc-YJ_NJ-Z3_TZSMzRV2Jthc-FYGpnQoycZmvVpv/pub?gid=0&single=true&output=csv";

        // Load data on window startup
        window.onload = async () => {
            await loadCityData();
        };

        async function loadCityData() {
            const statusEl = document.getElementById('dataLoadingStatus');
            const checkBtn = document.getElementById('checkBtn');
            const btnText = document.getElementById('btnText');

            try {
                const response = await fetch(csvUrl);
                if (!response.ok) throw new Error("Failed to reach database");
                const csvText = await response.text();
                
                // Parse CSV (Expected headers: city_ascii, state_id, lat, lng, population)
                const lines = csvText.split('\n');
                const midwestStates = ['IA', 'WI', 'MN', 'NE', 'MO', 'IL'];
                
                hubs = lines.slice(1).map(line => {
                    const parts = line.split(',');
                    if (parts.length < 5) return null;
                    
                    const name = parts[0].replace(/"/g, '').trim();
                    const state = parts[1].replace(/"/g, '').trim();
                    const lat = parseFloat(parts[2]);
                    const lon = parseFloat(parts[3]);
                    const pop = parseInt(parts[4]) || 0;

                    // Apply Logic:
                    // Priority states: all
                    // Others: population >= 1,000
                    if (midwestStates.includes(state) || pop >= 1000) {
                        return { name, state, lat, lon, pop };
                    }
                    return null;
                }).filter(h => h !== null);

                statusEl.innerHTML = `âœ… Database Loaded: ${hubs.length.toLocaleString()} transit points active.`;
                statusEl.className = "mb-6 p-4 bg-green-50 border border-green-200 rounded-lg text-green-800 font-medium text-sm flex items-center gap-3";
                
                checkBtn.disabled = false;
                btnText.innerText = "Analyze Route Alerts";
                
                console.log(`Loaded ${hubs.length} hubs from external source.`);
            } catch (err) {
                console.error(err);
                statusEl.innerHTML = `âŒ Error loading city database. Using minimal backup.`;
                statusEl.className = "mb-6 p-4 bg-red-50 border border-red-200 rounded-lg text-red-800 font-medium text-sm flex items-center gap-3";
                checkBtn.disabled = false;
                btnText.innerText = "Analyze Route (Backup Mode)";
                
                // Fallback minimal list in case of network failure
                hubs = [{ name: "Kalona", state: "IA", lat: 41.4770, lon: -91.7063 }];
            }
        }

        function log(msg, isError = false) {
            console.log(`[TRIP] ${msg}`);
            const logBox = document.getElementById('debugLog');
            const lines = document.getElementById('logLines');
            logBox.classList.remove('hidden');
            const entry = document.createElement('div');
            entry.style.color = isError ? '#ff6b6b' : '#4ade80';
            entry.innerText = `> ${msg}`;
            lines.appendChild(entry);
            logBox.scrollTop = logBox.scrollHeight;
        }

        async function geocode(location) {
            log(`Geocoding: ${location}...`);
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), 4000);
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(location)}&countrycodes=us&limit=1`, { 
                    signal: controller.signal,
                    headers: { 'Accept': 'application/json' }
                });
                clearTimeout(id);
                const data = await response.json();
                if (data && data.length > 0) {
                    const res = data[0];
                    const displayName = res.display_name;
                    const manualStateMatch = location.match(/\b([A-Z]{2})\b/i);
                    const state = manualStateMatch ? manualStateMatch[1].toUpperCase() : "US";

                    return {
                        name: location.split(',')[0].trim(),
                        state: state,
                        lat: parseFloat(res.lat),
                        lon: parseFloat(res.lon),
                        display: res.display_name
                    };
                }
            } catch (err) {
                log(`Geocode service unavailable: ${err.name === 'AbortError' ? 'Timeout' : err.message}.`, true);
            }
            log("Attempting local database match...");
            const inputLower = location.toLowerCase();
            const manualStateMatch = location.match(/\b([A-Z]{2})\b/i);
            const stateCode = manualStateMatch ? manualStateMatch[1].toUpperCase() : null;

            let localHub = hubs.find(h => inputLower.includes(h.name.toLowerCase().split('/')[0]));
            if (!localHub && stateCode) localHub = hubs.find(h => h.state === stateCode);
            if (localHub) {
                log(`Using closest hub: ${localHub.name}`);
                return { ...localHub, lon: localHub.lon || localHub.lng };
            }
            return null;
        }

        function initMap() {
            if (!map) {
                map = L.map('map').setView([39.8283, -98.5795], 4);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; OpenStreetMap contributors'
                }).addTo(map);
                routeLayer = L.layerGroup().addTo(map);
                markerLayer = L.layerGroup().addTo(map);
            }
        }

        async function calculateAndCheck() {
            const startStr = document.getElementById('startInput').value.trim();
            const endStr = document.getElementById('endInput').value.trim();
            if (!startStr || !endStr) {
                alert("Please enter both locations.");
                return;
            }

            const loading = document.getElementById('loading');
            const resultsArea = document.getElementById('resultsArea');
            const tableBody = document.getElementById('alertTableBody');
            const routeSummary = document.getElementById('routeSummary');
            const pathDisplay = document.getElementById('pathDisplay');
            const logLines = document.getElementById('logLines');

            logLines.innerHTML = '';
            loading.classList.remove('hidden');
            resultsArea.classList.add('hidden');
            routeSummary.classList.add('hidden');
            tableBody.innerHTML = '';
            pathDisplay.innerHTML = '';

            try {
                const startPoint = await geocode(startStr);
                const endPoint = await geocode(endStr);
                if (!startPoint || !endPoint) {
                    const missing = !startPoint ? startStr : endStr;
                    log(`Error: Could not locate "${missing}"`, true);
                    alert(`Could not find coordinates for "${missing}". Try a larger nearby city.`);
                    return;
                }

                log("Analyzing corridor vector...");
                const corridorHubs = determineCorridor(startPoint, endPoint);
                const routePoints = [startPoint, ...corridorHubs, endPoint];
                
                const finalRoutePoints = [];
                const seenNames = new Set();
                routePoints.forEach(p => {
                    const shortName = p.name.split('/')[0].toLowerCase();
                    if (!seenNames.has(shortName)) {
                        seenNames.add(shortName);
                        finalRoutePoints.push(p);
                    }
                });

                log(`Path identified with ${finalRoutePoints.length} total points.`);
                
                finalRoutePoints.forEach((c, i) => {
                    const span = document.createElement('span');
                    span.className = "bg-blue-100 text-blue-800 px-3 py-1 rounded text-base font-bold border border-blue-200";
                    span.innerText = c.name;
                    pathDisplay.appendChild(span);
                    if (i < finalRoutePoints.length - 1) {
                        pathDisplay.innerHTML += `<span class="text-slate-400 mx-1">â†’</span>`;
                    }
                });
                routeSummary.classList.remove('hidden');

                initMap();
                drawRouteMap(finalRoutePoints);

                const seenAlerts = new Set();

                for (let i = 0; i < finalRoutePoints.length; i++) {
                    const point = finalRoutePoints[i];
                    log(`Polling alerts for ${point.name}...`);
                    let cityAlertsFound = false;
                    
                    try {
                        const response = await fetch(`https://api.weather.gov/alerts/active?point=${point.lat},${point.lon}`);
                        if (!response.ok) throw new Error("Point request failed");
                        const data = await response.json();

                        if (data.features && data.features.length > 0) {
                            const filtered = data.features.filter(f => {
                                const e = f.properties.event.toLowerCase();
                                return e.includes('winter') || e.includes('ice') || e.includes('snow') || e.includes('cold') || e.includes('blizzard') || e.includes('sleet') || e.includes('wind');
                            });

                            if (filtered.length > 0) {
                                log(`Found ${filtered.length} relevant alerts for ${point.name}`);
                                cityAlertsFound = true;
                            }

                            filtered.forEach(alert => {
                                const key = `${point.name}-${alert.properties.event}-${alert.properties.headline}`;
                                if (!seenAlerts.has(key)) {
                                    seenAlerts.add(key);
                                    appendRow(point, alert, tableBody);
                                }
                            });
                        }
                    } catch (e) {
                        log(`Warning: Failed to fetch data for ${point.name}.`, true);
                    }

                    // START or END city with no reports: show "no reports issued" line
                    if (!cityAlertsFound && (i === 0 || i === finalRoutePoints.length - 1)) {
                        appendEmptyRow(point, tableBody);
                    }
                }

                document.getElementById('timestamp').innerText = `Updated: ${new Date().toLocaleTimeString()}`;
                resultsArea.classList.remove('hidden');
                setTimeout(() => map.invalidateSize(), 200);

            } catch (err) {
                log(`Critical Failure: ${err.message}`, true);
                alert("An error occurred. Please try again.");
            } finally {
                loading.classList.add('hidden');
            }
        }

        function determineCorridor(start, end) {
            const vx = end.lon - start.lon;
            const vy = end.lat - start.lat;
            const magSq = vx * vx + vy * vy;

            let corridor = hubs.map(h => {
                const hx = (h.lon || h.lng) - start.lon;
                const hy = h.lat - start.lat;
                const t = (hx * vx + hy * vy) / magSq;
                const projX = start.lon + t * vx;
                const projY = start.lat + t * vy;
                const perpDist = Math.sqrt(Math.pow((h.lon || h.lng) - projX, 2) + Math.pow(h.lat - projY, 2));
                return { ...h, t, perpDist, lon: (h.lon || h.lng) };
            });

            // Filtering logic: progress between 5% and 95% and within 80 miles of center line
            corridor = corridor.filter(h => h.t >= 0.05 && h.t <= 0.95 && h.perpDist < 1.2);
            corridor.sort((a, b) => a.t - b.t);

            const unique = [];
            const seen = new Set();
            corridor.forEach(c => {
                const sn = c.name.split('/')[0].toLowerCase();
                if(!seen.has(sn)) {
                    seen.add(sn);
                    unique.push(c);
                }
            });

            if (unique.length > 7) {
                const step = (unique.length - 1) / 6;
                const pruned = [];
                for(let i=0; i<7; i++) pruned.push(unique[Math.round(i * step)]);
                return pruned;
            }
            return unique;
        }

        function drawRouteMap(points) {
            routeLayer.clearLayers();
            markerLayer.clearLayers();
            const latlngs = points.map(p => [p.lat, p.lon]);

            L.polyline(latlngs, {
                color: '#3b82f6',
                weight: 4,
                dashArray: '10, 10',
                opacity: 0.8
            }).addTo(routeLayer);

            points.forEach((p, i) => {
                const isStart = i === 0;
                const isEnd = i === points.length - 1;
                const name = isStart ? "START" : (isEnd ? "END" : p.name.split('/')[0]);
                const color = isStart ? '#10b981' : (isEnd ? '#ef4444' : '#3b82f6');
                
                L.circleMarker([p.lat, p.lon], {
                    radius: isStart || isEnd ? 8 : 5,
                    fillColor: color,
                    color: "#fff",
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 1
                }).addTo(markerLayer).bindTooltip(name, { permanent: true, direction: 'top', offset: [0, -10] });
            });

            // Consistent Zoom Level 5 for regional context
            map.fitBounds(L.latLngBounds(latlngs), { 
                padding: [150, 150], 
                maxZoom: 5 
            });
        }

        function appendRow(hub, alert, tbody) {
            const rawHeadline = alert.properties.headline || '';
            const cleanHeadline = rawHeadline.split('...')[0].replace(/(IN EFFECT|REMAINS IN EFFECT|FROM|UNTIL|THROUGH).*/gi, '').trim();
            const cityName = hub.name.split('/')[0];
            const reportUrl = `https://forecast.weather.gov/MapClick.php?lat=${hub.lat}&lon=${hub.lon}`;
            const row = document.createElement('tr');
            row.className = "border-b border-slate-200 hover:bg-slate-50 transition";
            row.innerHTML = `
                <td class="p-2 font-black text-blue-900 align-middle text-2xl w-28 uppercase">${hub.state || 'US'}</td>
                <td class="p-2 font-bold text-slate-800 align-middle text-xl overflow-hidden text-ellipsis whitespace-nowrap w-48">${cityName}</td>
                <td class="p-2 align-middle w-40">
                    <span class="px-2 py-0.5 rounded text-[10px] font-black uppercase tracking-tighter block text-center ${getBadgeColor(alert.properties.event)}">${alert.properties.event}</span>
                </td>
                <td class="p-2 text-xl align-middle text-slate-700 font-bold leading-none w-64">
                    <div class="uppercase tracking-tight"><span class="text-slate-400 mr-2 text-[10px] uppercase">Starts</span> ${formatDate(alert.properties.effective)}</div>
                    <div class="uppercase tracking-tight mt-1"><span class="text-slate-400 mr-2 text-[10px] uppercase">Ends</span> ${formatDate(alert.properties.ends || alert.properties.expires)}</div>
                </td>
                <td class="p-2 align-middle">
                    <div class="flex items-center gap-3 overflow-hidden">
                         <a href="${reportUrl}" target="_blank" class="bg-slate-800 text-white px-3 py-1.5 rounded text-[10px] font-bold uppercase tracking-widest hover:bg-blue-600 transition shadow-md shrink-0">View Link</a>
                         <p class="font-bold text-slate-800 text-xl overflow-hidden text-ellipsis whitespace-nowrap" title="${rawHeadline.replace(/"/g, '&quot;')}">${cleanHeadline || rawHeadline}</p>
                    </div>
                </td>
            `;
            tbody.appendChild(row);
        }

        function appendEmptyRow(hub, tbody) {
            const cityName = hub.name.split('/')[0];
            const reportUrl = `https://forecast.weather.gov/MapClick.php?lat=${hub.lat}&lon=${hub.lon}`;
            const row = document.createElement('tr');
            row.className = "border-b border-slate-200 bg-slate-50 opacity-75";
            row.innerHTML = `
                <td class="p-2 font-black text-slate-400 align-middle text-2xl w-28 uppercase">${hub.state || 'US'}</td>
                <td class="p-2 font-bold text-slate-400 align-middle text-xl w-48">${cityName}</td>
                <td class="p-2 align-middle w-40 text-center">
                    <span class="px-2 py-0.5 rounded text-[10px] font-black uppercase tracking-tighter bg-slate-200 text-slate-500">None</span>
                </td>
                <td class="p-2 text-xl align-middle text-slate-400 font-medium w-64 italic">
                    Clear Conditions
                </td>
                <td class="p-2 align-middle">
                    <div class="flex items-center gap-3 overflow-hidden">
                         <a href="${reportUrl}" target="_blank" class="bg-slate-300 text-slate-600 px-3 py-1.5 rounded text-[10px] font-bold uppercase tracking-widest hover:bg-slate-400 transition shadow-sm shrink-0">View</a>
                         <p class="text-slate-400 text-xl italic">No reports issued on this line</p>
                    </div>
                </td>
            `;
            tbody.appendChild(row);
        }

        function getBadgeColor(event) {
            const e = event.toLowerCase();
            if (e.includes('warning')) return 'bg-red-600 text-white';
            if (e.includes('watch')) return 'bg-orange-500 text-white';
            return 'bg-blue-600 text-white';
        }

        function formatDate(str) {
            if (!str) return "--";
            const d = new Date(str);
            const hour = d.getHours();
            let period = "Night";
            // Normalizing precise hours to broad trucking periods
            if (hour >= 5 && hour < 12) period = "Morning";
            else if (hour >= 12 && hour < 17) period = "Noon";
            const datePart = d.toLocaleDateString([], {month: 'short', day: 'numeric'});
            return `${datePart} (${period})`;
        }
    </script>
</body>
</html>
